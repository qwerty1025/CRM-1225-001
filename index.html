<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶é…é€ç³»çµ± v4.0 - çµæ§‹å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbUpdate = update;
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="app" class="min-h-screen flex flex-col">
        
        <nav class="bg-indigo-800 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-50">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span>ğŸš›</span> ç¾Šå¥¶é…é€ç®¡ç†
            </h1>
            <div class="flex gap-2 text-sm">
                <button @click="switchView('manager')" :class="currentView==='manager' ? 'bg-indigo-500 ring-2 ring-indigo-300' : 'bg-indigo-700'" class="px-4 py-2 rounded-lg transition shadow">ç¶“ç†å¾Œå°</button>
                <button @click="switchView('delivery')" :class="currentView==='delivery' ? 'bg-emerald-600 ring-2 ring-emerald-300' : 'bg-indigo-700'" class="px-4 py-2 rounded-lg transition shadow">é…é€æ¨¡å¼</button>
            </div>
        </nav>

        <main class="flex-grow p-4 lg:p-6 max-w-7xl mx-auto w-full">

            <div v-if="currentView === 'manager'" class="space-y-6">
                
                <div class="bg-white p-6 rounded-xl shadow border border-gray-200">
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-grow w-full">
                            <label class="block text-sm font-bold text-gray-700 mb-1">ğŸ”— Google Sheet CSV é€£çµ</label>
                            <input type="text" v-model="sheetUrl" 
                                   placeholder="è«‹è²¼ä¸Šã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€çš„ CSV é€£çµ..."
                                   class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <button @click="syncFromSheet" :disabled="loading" 
                                class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 disabled:bg-gray-400 transition shadow flex items-center gap-2 whitespace-nowrap">
                            <span v-if="loading" class="animate-spin">ğŸŒ€</span>
                            {{ loading ? 'è³‡æ–™è™•ç†ä¸­...' : 'åŒæ­¥æ›´æ–°è³‡æ–™åº«' }}
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        * æ”¯æ´å…¨å½¢æ•¸å­—ä¿®æ­£ (ï¼’ -> 2)<br>
                        * æ ¼å¼ï¼š[é€±æœŸ, æ¬¡åº, åç¨±, è¡—å€, é€±ä¸€(5)...é€±æ—¥(5)]
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center flex-wrap gap-2">
                        <h2 class="font-bold text-gray-700 flex items-center gap-2">
                            <span>ğŸ‘¥</span> å®¢æˆ¶è³‡æ–™åº« <span class="text-xs font-normal text-gray-500">({{ sortedCustomers.length }} ç­†)</span>
                        </h2>
                        <div class="flex gap-2">
                            <button @click="generateDailyLogs" class="bg-amber-500 text-white px-4 py-1.5 rounded text-sm hover:bg-amber-600 shadow">
                                ğŸ“… æ›´æ–° 12æœˆ/1æœˆ é…é€å–®
                            </button>
                        </div>
                    </div>

                    <div v-if="editingId" class="p-4 bg-blue-50 border-b border-blue-100 transition-all">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-blue-800">âœï¸ ç·¨è¼¯å®¢æˆ¶ï¼š{{ editingCust.name }}</h3>
                            <button @click="cancelEdit" class="text-gray-500 text-sm hover:text-gray-700">å–æ¶ˆ</button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                            <div><label class="text-xs">æ¬¡åº</label><input v-model.number="editingCust.order" class="w-full p-1 border rounded"></div>
                            <div><label class="text-xs">åç¨±</label><input v-model="editingCust.name" class="w-full p-1 border rounded"></div>
                            <div><label class="text-xs">è¡—å€</label><input v-model="editingCust.area" class="w-full p-1 border rounded"></div>
                            <div><label class="text-xs">é€±æœŸ</label><input v-model="editingCust.cycle" class="w-full p-1 border rounded"></div>
                        </div>
                        <div class="overflow-x-auto bg-white p-2 rounded border">
                            <div class="flex min-w-[600px] text-center text-xs font-bold border-b pb-1 mb-1">
                                <div class="w-10"></div>
                                <div class="flex-1 text-blue-600">åŸ</div>
                                <div class="flex-1 text-pink-500">ç”œ</div>
                                <div class="flex-1 text-amber-700">å·§</div>
                                <div class="flex-1 text-red-500">è“</div>
                                <div class="flex-1 text-yellow-600">é»‘</div>
                            </div>
                            <div v-for="(day, dIdx) in 7" :key="dIdx" class="flex min-w-[600px] items-center py-1 border-b last:border-0">
                                <div class="w-10 font-bold text-gray-400">{{ weekDays[dIdx] }}</div>
                                <div v-for="(f, fIdx) in 5" :key="fIdx" class="flex-1 px-1">
                                    <input type="number" min="0" v-model.number="editingCust.pattern[dIdx*5 + fIdx]" 
                                           class="w-full text-center border rounded focus:bg-blue-50">
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-right">
                            <button @click="saveEdit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 shadow">å„²å­˜è®Šæ›´</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10">
                                <tr>
                                    <th class="p-3 border-b">æ¬¡åº</th>
                                    <th class="p-3 border-b">é€±æœŸ</th>
                                    <th class="p-3 border-b">åç¨±</th>
                                    <th class="p-3 border-b">è¡—å€</th>
                                    <th v-for="d in weekDays" :key="d" class="p-3 border-b text-center min-w-[40px]">{{d}}</th>
                                    <th class="p-3 border-b text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="cust in sortedCustomers" :key="cust.id" class="hover:bg-indigo-50 border-b group transition">
                                    <td class="p-3 font-mono text-gray-500">{{ cust.order }}</td>
                                    <td class="p-3 text-gray-500 text-xs">{{ cust.cycle }}</td>
                                    <td class="p-3 font-bold text-gray-800">{{ cust.name }}</td>
                                    <td class="p-3 text-gray-600">{{ cust.area }}</td>
                                    <td v-for="i in 7" :key="i" class="p-3 text-center border-l border-gray-100">
                                        <span v-if="getDaySum(cust.pattern, i-1) > 0" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 font-bold text-xs">
                                            {{ getDaySum(cust.pattern, i-1) }}
                                        </span>
                                        <span v-else class="text-gray-200">-</span>
                                    </td>
                                    <td class="p-3 text-right">
                                        <button @click="startEdit(cust)" class="text-blue-600 hover:text-blue-800 border border-blue-200 px-2 py-1 rounded text-xs hover:bg-blue-50">ç·¨è¼¯</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'delivery'" class="space-y-4 max-w-lg mx-auto">
                
                <div class="sticky top-20 z-30 bg-white/95 backdrop-blur shadow-md rounded-xl p-3 flex justify-between items-center border border-gray-200">
                    <button @click="changeDate(-1)" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full active:bg-gray-200">â—€</button>
                    <div class="text-center cursor-pointer relative group">
                         <div class="text-xs text-gray-500 font-bold">{{ getWeekDayName(selectedDate) }}</div>
                         <div class="text-xl font-bold text-gray-800">{{ selectedDate.substring(5) }}</div>
                         <input type="date" v-model="selectedDate" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    <button @click="changeDate(1)" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full active:bg-gray-200">â–¶</button>
                </div>

                <div v-if="sortedDailyList.length > 0" class="pb-24 space-y-3">
                    <div v-for="item in sortedDailyList" :key="item.id" 
                         class="bg-white rounded-xl shadow-sm border p-4 transition-all duration-300 relative overflow-hidden"
                         :class="item.status === 'delivered' ? 'border-green-200 bg-green-50/30' : 'border-gray-200'">
                        
                        <div class="absolute left-0 top-0 bottom-0 w-1" :class="item.status === 'delivered' ? 'bg-green-500' : 'bg-blue-500'"></div>

                        <div class="flex gap-3 pl-2">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-gray-800 text-white text-[10px] px-1.5 py-0.5 rounded font-mono">{{ item.order }}</span>
                                    <span class="font-bold text-lg text-gray-800" :class="{'line-through text-gray-400': item.status==='delivered'}">{{ item.name }}</span>
                                </div>
                                <div class="text-xs text-gray-500 mb-2">{{ item.area }}</div>
                                
                                <div class="flex flex-wrap gap-1.5 mb-3">
                                    <template v-for="(qty, type) in item.items" :key="type">
                                        <span v-if="qty > 0" class="px-2 py-0.5 rounded text-xs font-bold border"
                                              :class="flavorStyle(type)">
                                            {{ flavorName(type) }} {{ qty }}
                                        </span>
                                    </template>
                                </div>

                                <div class="relative">
                                    <input type="text" v-model.lazy="item.note" @change="updateNote(item)"
                                           placeholder="å‚™è¨»..." 
                                           class="w-full bg-gray-50 text-sm border-b border-gray-200 focus:border-blue-500 outline-none py-1 px-1 transition placeholder-gray-400">
                                </div>
                            </div>

                            <div class="flex flex-col justify-center shrink-0">
                                <button @click="toggleStatus(item)" 
                                        class="w-14 h-14 rounded-full flex items-center justify-center text-2xl shadow transition-transform active:scale-95 border-2"
                                        :class="item.status === 'delivered' ? 'bg-green-500 text-white border-green-500' : 'bg-white text-gray-200 border-gray-100'">
                                    {{ item.status === 'delivered' ? 'âœ“' : 'â—‹' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="text-center py-16">
                    <div class="text-4xl mb-3">ğŸƒ</div>
                    <div class="text-gray-400">æœ¬æ—¥ç„¡é…é€ä»»å‹™</div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const currentView = ref('manager');
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const sheetUrl = ref('');
                const loading = ref(false);
                const customers = ref({});
                const dailyData = ref({});
                const weekDays = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
                
                // ç·¨è¼¯ç‹€æ…‹
                const editingId = ref(null);
                const editingCust = reactive({
                    id: '', order: 0, name: '', area: '', cycle: '', pattern: []
                });

                // --- Firebase åˆå§‹åŒ– ---
                onMounted(() => {
                    // ç›£è½å®¢æˆ¶è³‡æ–™
                    window.dbOnValue(window.dbRef(window.db, 'customers'), (snap) => {
                        customers.value = snap.val() || {};
                    });
                    // ç›£è½ä»Šæ—¥é…é€
                    loadDailyData(selectedDate.value);
                });

                // --- CSV è§£æé‚è¼¯ (æ ¸å¿ƒ) ---
                const normalizeNum = (val) => {
                    if (!val) return 0;
                    // å…¨å½¢è½‰åŠå½¢
                    const str = val.toString().replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248));
                    const num = parseInt(str);
                    return isNaN(num) ? 0 : num;
                };

                async function syncFromSheet() {
                    if (!sheetUrl.value) return alert("è«‹å…ˆè²¼ä¸Šç¶²å€");
                    loading.value = true;
                    try {
                        const res = await fetch(sheetUrl.value);
                        const text = await res.text();
                        // è™•ç† CSVï¼šæœ‰äº› CSV æœƒç”¨å¼•è™ŸåŒ…ä½å«é€—è™Ÿçš„å…§å®¹ï¼Œé€™è£¡åšç°¡æ˜“è™•ç† split
                        // å‡è¨­ Google Sheet åŒ¯å‡ºæ ¼å¼è¼ƒç‚ºæ¨™æº–
                        const rows = text.split('\n');
                        
                        const updates = {};
                        let count = 0;

                        rows.forEach((row) => {
                            // ç°¡æ˜“ CSV è§£æï¼Œè‹¥æ¬„ä½å…§æœ‰é€—è™Ÿæœƒå‡ºéŒ¯ï¼Œä½†é€šå¸¸é€™ç¨®æ•¸å­—è¡¨æ ¼ä¸æœƒæœ‰
                            const cols = row.split(',').map(c => c.trim());
                            
                            // ä¾æ‚¨çš„æª”æ¡ˆçµæ§‹ï¼š Col 1 æ˜¯ Orderï¼Œå¿…é ˆæ˜¯æ•¸å­—æ‰è¦–ç‚ºè³‡æ–™åˆ—
                            const orderRaw = cols[1];
                            const order = normalizeNum(orderRaw);

                            // æ¢ä»¶ï¼šCol 1 æ˜¯æœ‰æ•ˆæ•¸å­—ï¼Œä¸”ä¸æ˜¯æ¨™é¡Œåˆ— (Order > 0)
                            if (order > 0 && cols.length >= 39) {
                                // ç”¢ç”Ÿ ID
                                const id = 'cust_' + order.toString().padStart(3, '0');
                                
                                // è§£æ pattern: å¾ index 4 é–‹å§‹åˆ° 38 (å…±35å€‹)
                                const pattern = [];
                                for(let i=4; i<=38; i++) {
                                    pattern.push(normalizeNum(cols[i]));
                                }

                                updates[`customers/${id}`] = {
                                    cycle: cols[0] || '', // Col 0
                                    order: order,         // Col 1
                                    name: cols[2],        // Col 2
                                    area: cols[3],        // Col 3
                                    pattern: pattern
                                };
                                count++;
                            }
                        });

                        if (count > 0) {
                            await window.dbUpdate(window.dbRef(window.db), updates);
                            alert(`æˆåŠŸåŒæ­¥ ${count} ç­†å®¢æˆ¶è³‡æ–™ï¼`);
                            // æ¸…ç©ºèˆŠçš„é¡¯ç¤º
                            editingId.value = null;
                        } else {
                            alert("æœªåµæ¸¬åˆ°æœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥ CSV æ ¼å¼æˆ–é€£çµã€‚");
                        }

                    } catch (e) {
                        alert("åŒæ­¥éŒ¯èª¤ï¼š" + e.message);
                    }
                    loading.value = false;
                }

                // --- ç¶“ç†åŠŸèƒ½ï¼šç·¨è¼¯èˆ‡ç”Ÿæˆ ---
                function startEdit(cust) {
                    editingId.value = cust.id;
                    editingCust.id = cust.id;
                    editingCust.order = cust.order;
                    editingCust.name = cust.name;
                    editingCust.area = cust.area;
                    editingCust.cycle = cust.cycle;
                    // Deep copy pattern
                    editingCust.pattern = [...cust.pattern];
                    // æ»¾å‹•åˆ°é ‚éƒ¨
                    window.scrollTo({top:0, behavior:'smooth'});
                }

                function cancelEdit() {
                    editingId.value = null;
                }

                async function saveEdit() {
                    const refPath = `customers/${editingCust.id}`;
                    await window.dbUpdate(window.dbRef(window.db, refPath), {
                        order: editingCust.order,
                        name: editingCust.name,
                        area: editingCust.area,
                        cycle: editingCust.cycle,
                        pattern: editingCust.pattern
                    });
                    alert("ä¿®æ”¹å·²å„²å­˜");
                    editingId.value = null;
                }

                async function generateDailyLogs() {
                    if(!confirm("ç¢ºå®šè¦æ›´æ–° 12æœˆ/1æœˆ çš„é…é€å–®å—ï¼Ÿé€™å°‡è¦†è“‹èˆŠæœ‰ç´€éŒ„ã€‚")) return;
                    loading.value = true;
                    const updates = {};
                    const start = new Date("2025-12-01");
                    const end = new Date("2026-01-31");
                    
                    const allCusts = Object.entries(customers.value);

                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const dStr = d.toISOString().split('T')[0];
                        let jsDay = d.getDay(); // 0=Sun
                        let pIdx = jsDay === 0 ? 6 : jsDay - 1; // 0=Mon...6=Sun

                        allCusts.forEach(([id, c]) => {
                            const base = pIdx * 5;
                            // å®‰å…¨æª¢æŸ¥
                            if(!c.pattern) return;

                            const items = {
                                original: c.pattern[base] || 0,
                                sweet: c.pattern[base+1] || 0,
                                choco: c.pattern[base+2] || 0,
                                strawberry: c.pattern[base+3] || 0,
                                brown: c.pattern[base+4] || 0
                            };
                            
                            // åªè¦æœ‰é‡å°±ç”Ÿæˆ (æˆ–æ›´æ–°)
                            if (Object.values(items).reduce((a,b)=>a+b,0) > 0) {
                                updates[`daily_operations/${dStr}/${id}`] = {
                                    name: c.name,
                                    order: c.order,
                                    area: c.area,
                                    items: items,
                                    status: 'pending', // é è¨­æœªé€
                                    // è‹¥å¸Œæœ›ä¿ç•™èˆŠå‚™è¨»ï¼Œé€™è£¡é‚è¼¯æœƒæ¯”è¼ƒè¤‡é›œï¼Œç›®å‰æ¡è¦†è“‹é‡ç½®
                                    note: '' 
                                };
                            }
                        });
                    }
                    await window.dbUpdate(window.dbRef(window.db), updates);
                    loading.value = false;
                    alert("é…é€å–®ç”Ÿæˆå®Œç•¢ï¼");
                }

                // --- é…é€å“¡åŠŸèƒ½ ---
                const switchView = (v) => currentView.value = v;

                const sortedCustomers = computed(() => {
                    return Object.entries(customers.value)
                        .map(([k,v]) => ({id:k, ...v}))
                        .sort((a,b) => a.order - b.order);
                });

                const getDaySum = (pat, dayIdx) => {
                    if(!pat) return 0;
                    return pat.slice(dayIdx*5, dayIdx*5+5).reduce((a,b)=>a+b,0);
                };

                // --- æ—¥æœŸèˆ‡é…é€è³‡æ–™ ---
                function loadDailyData(date) {
                    const r = window.dbRef(window.db, `daily_operations/${date}`);
                    window.dbOnValue(r, (s) => {
                        dailyData.value = s.val() || {};
                    });
                }
                // Watcher is implicitly handled by onValue, but date change needs trigger
                const changeDate = (n) => {
                    const d = new Date(selectedDate.value);
                    d.setDate(d.getDate() + n);
                    selectedDate.value = d.toISOString().split('T')[0];
                    loadDailyData(selectedDate.value);
                };

                const sortedDailyList = computed(() => {
                    return Object.entries(dailyData.value)
                        .map(([k,v]) => ({id:k, ...v}))
                        .sort((a,b) => a.order - b.order);
                });

                const toggleStatus = (item) => {
                    const next = item.status === 'delivered' ? 'pending' : 'delivered';
                    window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${item.id}`), {status: next});
                };

                const updateNote = (item) => {
                     window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${item.id}`), {note: item.note});
                };

                // --- UI Helper ---
                const getWeekDayName = (dStr) => weekDays[new Date(dStr).getDay()];
                const flavorName = (k) => ({original:'åŸ', sweet:'ç”œ', choco:'å·§', strawberry:'è“', brown:'é»‘'}[k]);
                const flavorStyle = (k) => ({
                    original: 'bg-blue-50 text-blue-700 border-blue-200',
                    sweet: 'bg-pink-50 text-pink-700 border-pink-200',
                    choco: 'bg-amber-50 text-amber-800 border-amber-200',
                    strawberry: 'bg-red-50 text-red-700 border-red-200',
                    brown: 'bg-yellow-50 text-yellow-800 border-yellow-200'
                }[k]);

                return {
                    currentView, switchView, selectedDate, sheetUrl, loading, 
                    weekDays, sortedCustomers, editingId, editingCust,
                    syncFromSheet, startEdit, cancelEdit, saveEdit, generateDailyLogs,
                    sortedDailyList, changeDate, toggleStatus, updateNote,
                    getDaySum, getWeekDayName, flavorName, flavorStyle
                };
            }
        }).mount('#app');
    </script>
</body>
</html>