<div id="app" class="flex flex-col mx-auto bg-slate-50 min-h-screen text-slate-800 antialiased" style="max-width: 430px; font-family: -apple-system, sans-serif;">

    <style>
        :root { --ios-safe-bottom: env(safe-area-inset-bottom, 20px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .main-scroll-area { height: calc(100vh - 150px); overflow-y: auto; padding-bottom: 40px; }
        .state-ready { background-color: #f5f3ff !important; color: #6366f1; border: 2px dashed #c7d2fe !important; } 
        .state-success { background-color: #22c55e !important; color: white; border: none !important; } 
        .state-leave { background-color: #0f172a !important; color: white; border: none !important; }   
        .state-fail { background-color: #ef4444 !important; color: white; border: none !important; }
        .day-cell { aspect-ratio: 1/1.2; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; transition: transform 0.1s; }
        .day-cell:active { transform: scale(0.92); }
        .flavor-tag { font-size: 8px; line-height: 1; margin-top: 2px; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 430px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; padding-top: 12px; padding-bottom: var(--ios-safe-bottom); z-index: 50; }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <header class="h-[60px] bg-white border-b border-slate-100 flex items-center justify-between px-5 sticky top-0 z-40">
        <div>
            <span class="text-xs font-black text-indigo-500 uppercase tracking-tighter">Delivery Pro V14</span>
            <h1 class="text-xl font-black text-slate-900 leading-tight">配送員<span class="text-indigo-600">助手</span></h1>
        </div>
        <button v-if="activeTab === 'C'" @click="openEdit(null)" class="w-10 h-10 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center">
            <i class="fas fa-plus"></i>
        </button>
    </header>

    <main class="main-scroll-area">
        
        <div v-if="activeTab === 'A'" class="p-4 space-y-4">
            <div class="flex overflow-x-auto gap-2 no-scrollbar">
                <button v-for="b in blocks" @click="selectedBlock = b" :class="['whitespace-nowrap px-6 py-2.5 rounded-full text-sm font-black shadow-sm', selectedBlock === b ? 'bg-slate-900 text-white' : 'bg-white text-slate-400 border border-slate-200']">{{ b }}</button>
            </div>
            <div class="flex overflow-x-auto gap-2 no-scrollbar">
                <button v-for="c in filteredCustomers" @click="selectedCid = c.id" :class="['whitespace-nowrap px-5 py-3 rounded-2xl text-sm font-bold border-2 transition-all', selectedCid === c.id ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-transparent bg-white text-slate-500']">{{ c.name }}</button>
            </div>
            <div v-if="currentCustomer" class="space-y-4">
                <div class="bg-indigo-700 p-6 rounded-[2.5rem] text-white shadow-xl flex justify-between items-end relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-[10px] font-bold opacity-60 uppercase mb-1">{{ currentCustomer.rate }} 元 / 瓶</p>
                        <h2 class="text-3xl font-black mb-1">{{ currentCustomer.name }}</h2>
                    </div>
                    <div class="text-right z-10"><p class="text-[10px] font-bold opacity-60">本月結算</p><p class="text-3xl font-black text-emerald-300 tracking-tighter">${{ currentMonthTotal }}</p></div>
                </div>
                <div class="bg-white rounded-[2.5rem] p-4 shadow-sm border border-slate-200">
                    <div class="calendar-grid">
                        <div v-for="d in ['一','二','三','四','五','六','日']" class="text-center text-[10px] font-black text-slate-300 pb-2">{{ d }}</div>
                        <div v-for="day in calendarDays" :key="day.dateKey" @click="day.date && toggleStatus(selectedCid, day.dateKey)" :class="['day-cell', day.date ? 'bg-slate-50' : 'opacity-0', getStatusClass(selectedCid, day.dateKey)]">
                            <span class="text-xs mb-1">{{ day.date }}</span>
                            <div v-if="day.date && isExpectedDay(selectedCid, day.dateKey)" class="flavor-tag font-black">{{ getFlavorByWeekday(selectedCid, day.dateKey) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'B'" class="p-5 space-y-5 animate-fade-in">
            <div class="flex overflow-x-auto gap-2 no-scrollbar pb-1">
                <button v-for="n in 6" @click="prepOffset = n-1" :class="['whitespace-nowrap px-5 py-3 rounded-2xl font-bold text-sm', prepOffset === n-1 ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-400 border border-slate-100']">{{ getPrepDateLabel(n-1) }}</button>
            </div>
            <div class="bg-indigo-600 p-8 rounded-[3rem] text-white shadow-2xl">
                <h3 class="text-xs font-black opacity-60 mb-2 uppercase tracking-widest">{{ getPrepDateFull(prepOffset) }} 備貨</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(count, f) in prepSummary" :key="f" v-show="count > 0" class="bg-white/10 p-4 rounded-2xl border border-white/5">
                        <div class="text-[10px] opacity-60 font-bold">{{ f }}</div>
                        <div class="text-2xl font-black">{{ count }}瓶</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'C'" class="p-5 space-y-6 animate-fade-in">
            <div class="bg-white p-6 rounded-[2.2rem] border border-indigo-100 shadow-sm space-y-3">
                <div class="flex items-center gap-2 text-indigo-600 font-black text-sm mb-2">
                    <i class="fa-solid fa-file-csv"></i> 批量匯入訂戶 (.csv)
                </div>
                <input type="file" id="csv-input" accept=".csv" class="hidden" @change="handleCSVUpload">
                <label for="csv-input" class="block w-full py-4 bg-indigo-50 text-indigo-600 rounded-2xl text-center font-bold text-sm cursor-pointer active:bg-indigo-100">
                    <i class="fa-solid fa-cloud-arrow-up mr-2"></i> 選擇 CSV 檔案
                </label>
                <p class="text-[10px] text-slate-400 text-center leading-tight">請遵循 Google Sheets 範例格式<br>編碼建議使用 UTF-8</p>
            </div>

            <div class="h-px bg-slate-200 mx-4"></div>

            <div v-for="c in customers" @click="openEdit(c)" class="bg-white p-5 rounded-[2.2rem] border border-slate-200 flex justify-between items-center shadow-sm">
                <div>
                    <div class="font-black text-lg">{{ c.name }}</div>
                    <div class="flex gap-2 mt-1">
                        <span class="text-[9px] font-black bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full uppercase">{{ c.block }}路段</span>
                        <span class="text-[9px] font-black bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full">{{ c.rate }}元</span>
                    </div>
                </div>
                <i class="fa-solid fa-angle-right text-slate-300"></i>
            </div>
        </div>
    </main>

    <nav class="bottom-nav flex justify-around items-center">
        <button @click="activeTab = 'A'" :class="['flex flex-col items-center gap-1 w-1/4', activeTab === 'A' ? 'text-indigo-600' : 'text-slate-300']">
            <i class="fa-solid fa-calendar-day text-2xl"></i><span class="text-[10px] font-black">配送日曆</span>
        </button>
        <button @click="activeTab = 'B'" :class="['flex flex-col items-center gap-1 w-1/4', activeTab === 'B' ? 'text-indigo-600' : 'text-slate-300']">
            <i class="fa-solid fa-dolly text-2xl"></i><span class="text-[10px] font-black">準貨統計</span>
        </button>
        <button @click="activeTab = 'C'" :class="['flex flex-col items-center gap-1 w-1/4', activeTab === 'C' ? 'text-indigo-600' : 'text-slate-300']">
            <i class="fa-solid fa-users-gear text-2xl"></i><span class="text-[10px] font-black">訂戶管理</span>
        </button>
    </nav>

    <script>
        const { createApp, ref, reactive, computed, watch } = Vue;

        createApp({
            setup() {
                const activeTab = ref('A');
                const selectedBlock = ref('大埔');
                const selectedCid = ref('');
                const showModal = ref(false);
                const prepOffset = ref(0);
                const currentViewDate = ref(new Date());

                const customers = ref(JSON.parse(localStorage.getItem('goat_c_v14')) || []);
                const logs = reactive(JSON.parse(localStorage.getItem('goat_l_v14')) || {});
                const blocks = ref(JSON.parse(localStorage.getItem('goat_b_v14')) || ['大埔', '市場', '復興路']);
                
                watch(customers, v => localStorage.setItem('goat_c_v14', JSON.stringify(v)), { deep: true });
                watch(logs, v => localStorage.setItem('goat_l_v14', JSON.stringify(v)), { deep: true });
                watch(blocks, v => localStorage.setItem('goat_b_v14', JSON.stringify(v)), { deep: true });

                const flavors = ['原味','甜味','黑糖','巧克力','草莓'];
                const form = reactive({ id: null, name: '', block: '大埔', rate: 30, phone: '', weeklySchedule: [] });

                // --- 任務 2：CSV 匯入核心邏輯 ---
                const handleCSVUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        const newCustomers = [];

                        // 跳過標題列 (i=1)
                        for (let i = 1; i < lines.length; i++) {
                            const cols = lines[i].split(',');
                            if (cols.length < 4) continue; // 至少要有基礎資料

                            const name = cols[0].trim();
                            const block = cols[1].trim();
                            const rate = parseInt(cols[2]) || 30;
                            const phone = cols[3].trim();

                            // 生成週計畫 (每一天 5 個口味)
                            const weeklySchedule = [];
                            let colIndex = 4;
                            for (let day = 0; day < 7; day++) {
                                const dayObj = {};
                                flavors.forEach(f => {
                                    dayObj[f] = parseInt(cols[colIndex]) || 0;
                                    colIndex++;
                                });
                                weeklySchedule.push(dayObj);
                            }

                            newCustomers.push({
                                id: Date.now() + i + Math.random().toString(36).substr(2, 5),
                                name, block, rate, phone, weeklySchedule,
                                count: weeklySchedule.reduce((s, d) => s + Object.values(d).reduce((a,b)=>a+b, 0), 0) / 7
                            });

                            // 自動更新街區選單
                            if (!blocks.value.includes(block)) blocks.value.push(block);
                        }

                        if (confirm(`成功解析 ${newCustomers.length} 位訂戶，是否加入？`)) {
                            customers.value = [...customers.value, ...newCustomers];
                        }
                        event.target.value = ''; // 重置 input
                    };
                    reader.readAsText(file);
                };

                // --- 日曆與狀態邏輯 (略，與 V13.1 相同) ---
                // [此處包含 toggleStatus, getStatusClass, calendarDays 等函數]

                return { 
                    activeTab, selectedBlock, selectedCid, customers, blocks, prepOffset, logs, 
                    showModal, form, openEdit: (c) => { /* 編輯邏輯 */ },
                    handleCSVUpload, calendarDays, prepSummary: computed(() => { /* 準貨邏輯 */ }),
                    currentMonthTotal: computed(() => { /* 試算邏輯 */ }),
                    viewMonthLabel: computed(() => currentViewDate.value.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' })),
                    // ... 更多返回值
                };
            }
        }).mount('#app');
    </script>
</div>