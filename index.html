<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶é…é€ç³»çµ± v3.0 - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbUpdate = update;
    </script>
</head>
<body class="bg-slate-50 text-gray-800">
    <div id="app" class="min-h-screen flex flex-col">
        
        <nav class="bg-indigo-900 text-white p-4 shadow-xl flex justify-between items-center sticky top-0 z-50">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span>ğŸ“Š</span> é…é€ä¸­å¿ƒç®¡ç†ç³»çµ±
            </h1>
            <div class="flex gap-2 text-sm">
                <button @click="currentView = 'manager'" :class="currentView==='manager' ? 'bg-indigo-500 shadow-inner' : 'bg-indigo-800'" class="px-5 py-2 rounded-full transition">é›»è…¦ç‰ˆç¶“ç†</button>
                <button @click="currentView = 'delivery'" :class="currentView==='delivery' ? 'bg-emerald-600 shadow-inner' : 'bg-indigo-800'" class="px-5 py-2 rounded-full transition">æ‰‹æ©Ÿé…é€å“¡</button>
            </div>
        </nav>

        <main class="flex-grow p-4 lg:p-8 max-w-7xl mx-auto w-full">

            <div v-if="currentView === 'manager'" class="space-y-6">
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex-grow">
                            <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2 mb-2">
                                ğŸ”— Google Sheets è³‡æ–™ä¸²æ¥
                            </h2>
                            <input type="text" v-model="sheetUrl" 
                                   placeholder="åœ¨æ­¤è²¼ä¸Š Google Sheets ç™¼ä½ˆçš„ CSV é€£çµ..."
                                   class="w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button @click="syncFromSheet" :disabled="loading" 
                                    class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 disabled:bg-slate-400 transition shadow-md flex items-center gap-2">
                                <span v-if="loading" class="animate-spin">ğŸŒ€</span>
                                {{ loading ? 'åŒæ­¥ä¸­' : 'ç«‹å³åŒæ­¥è³‡æ–™' }}
                            </button>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 italic">* æ ¼å¼éœ€ç¬¦åˆï¼šé †åº, åç¨±, å€åŸŸ, é€±ä¸€(5), é€±äºŒ(5)...é€±æ—¥(5)</p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h2 class="font-bold text-slate-700">ğŸ“‹ Firebase å®¢æˆ¶å³æ™‚æ¸…å–® ({{ sortedCustomers.length }} ç­†)</h2>
                        <button @click="generateDailyLogs" class="bg-amber-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-amber-600 transition shadow">
                            ğŸ“… ç”¢ç”Ÿ 12æœˆ/1æœˆ é…é€å–®
                        </button>
                    </div>
                    <div class="overflow-x-auto overflow-y-auto max-h-[500px]">
                        <table class="w-full text-sm text-left border-collapse">
                            <thead class="bg-slate-100 text-slate-600 sticky top-0 z-10">
                                <tr>
                                    <th class="p-3 border-b">é †åº</th>
                                    <th class="p-3 border-b">å§“å</th>
                                    <th class="p-3 border-b">å€åŸŸ</th>
                                    <th v-for="day in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']" :key="day" class="p-3 border-b text-center border-l bg-slate-50/50">{{day}}</th>
                                    <th class="p-3 border-b">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="cust in sortedCustomers" :key="cust.id" class="hover:bg-indigo-50 transition border-b group">
                                    <td class="p-3 font-mono text-slate-400 text-xs">{{ cust.order }}</td>
                                    <td class="p-3 font-bold text-slate-700">{{ cust.name }}</td>
                                    <td class="p-3 text-slate-500">{{ cust.area }}</td>
                                    <td v-for="dIdx in 7" :key="dIdx" class="p-3 text-center border-l">
                                        <span v-if="getDayTotal(cust.pattern, dIdx-1) > 0" class="inline-block w-6 h-6 leading-6 rounded-full bg-indigo-100 text-indigo-600 font-bold text-[10px]">
                                            {{ getDayTotal(cust.pattern, dIdx-1) }}
                                        </span>
                                        <span v-else class="text-slate-200">-</span>
                                    </td>
                                    <td class="p-3">
                                        <button @click="deleteCustomer(cust.id)" class="text-rose-400 hover:text-rose-600 opacity-0 group-hover:opacity-100 transition">åˆªé™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'delivery'" class="space-y-4 max-w-md mx-auto">
                <div class="sticky top-20 z-40 bg-white shadow-lg rounded-2xl p-4 flex justify-between items-center border border-indigo-100">
                    <button @click="changeDate(-1)" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full">â—€</button>
                    <div class="text-center">
                        <div class="text-xs text-indigo-400 font-bold">{{ getWeekDay(selectedDate) }}</div>
                        <div class="font-bold text-xl text-slate-700">{{ selectedDate.substring(5) }}</div>
                    </div>
                    <button @click="changeDate(1)" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full">â–¶</button>
                </div>

                <div v-if="sortedDailyList.length > 0" class="space-y-3 pb-24">
                    <div v-for="item in sortedDailyList" :key="item.id" 
                         class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 flex items-center gap-4 transition-all"
                         :class="item.status === 'delivered' ? 'bg-slate-50 border-transparent opacity-60' : ''">
                        
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] bg-slate-700 text-white px-1.5 rounded font-mono">{{ item.order }}</span>
                                <span class="font-bold text-lg">{{ item.name }}</span>
                            </div>
                            <div class="flex gap-1 mb-2">
                                <span v-for="(val, key) in item.items" :key="key">
                                    <span v-if="val > 0" class="text-[11px] px-2 py-0.5 rounded-md" :class="getFlavorClass(key)">
                                        {{ getFlavorName(key) }}{{val}}
                                    </span>
                                </span>
                            </div>
                            <input type="text" v-model.lazy="item.note" @change="updateNote(item)"
                                   placeholder="é»æ“Šè¼¸å…¥æ¶ˆæ¯..." 
                                   class="w-full text-xs bg-slate-50 border-b border-transparent focus:border-indigo-400 outline-none p-1">
                        </div>

                        <button @click="toggleStatus(item)" 
                                class="w-14 h-14 rounded-2xl flex items-center justify-center text-3xl shadow-sm border-2 transition-all"
                                :class="item.status === 'delivered' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-white text-slate-200 border-slate-100'">
                            {{ item.status === 'delivered' ? 'âœ“' : 'â—‹' }}
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentView = ref('manager');
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const sheetUrl = ref(''); // å­˜å„² Google Sheet CSV ç¶²å€
                const loading = ref(false);
                const customers = ref({});
                const dailyData = ref({});

                // --- åˆå§‹åŒ–ï¼šå³æ™‚ç›£è½ Firebase ---
                onMounted(() => {
                    // 1. ç›£è½å®¢æˆ¶æ¯æª”
                    const custRef = window.dbRef(window.db, 'customers');
                    window.dbOnValue(custRef, (snapshot) => {
                        customers.value = snapshot.val() || {};
                    });

                    // 2. ç›£è½ç•¶å‰é…é€ç´€éŒ„
                    loadDailyData(selectedDate.value);
                });

                // --- ç¶“ç†åŠŸèƒ½ï¼šGoogle Sheet åŒæ­¥ ---
                async function syncFromSheet() {
                    if (!sheetUrl.value.includes('csv')) {
                        alert("è«‹ç¢ºèªé€£çµæ˜¯å¦ç‚ºã€Œç™¼ä½ˆç‚º CSVã€æ ¼å¼");
                        return;
                    }
                    loading.value = true;
                    try {
                        const response = await fetch(sheetUrl.value);
                        const csvText = await response.text();
                        const rows = csvText.split('\n').slice(1); // è·³éæ¨™é¡Œåˆ—
                        
                        const updates = {};
                        rows.forEach((row, index) => {
                            const cols = row.split(',').map(c => c.trim());
                            if (cols.length >= 38) {
                                const id = 'cust_' + (cols[0].padStart(3, '0')); // ä»¥åºè™Ÿç‚º ID
                                updates[`customers/${id}`] = {
                                    order: parseInt(cols[0]),
                                    name: cols[1],
                                    area: cols[2],
                                    pattern: cols.slice(3, 38).map(v => parseInt(v) || 0)
                                };
                            }
                        });

                        await window.dbUpdate(window.dbRef(window.db), updates);
                        alert("åŒæ­¥æˆåŠŸï¼è³‡æ–™å·²å³æ™‚åæ‡‰åœ¨ä¸‹æ–¹è¡¨æ ¼ã€‚");
                    } catch (e) {
                        alert("åŒæ­¥å¤±æ•—ï¼š" + e.message);
                    }
                    loading.value = false;
                }

                // --- ç¶“ç†åŠŸèƒ½ï¼šç”¢ç”Ÿé…é€å–® ---
                async function generateDailyLogs() {
                    loading.value = true;
                    const updates = {};
                    const startDate = new Date("2025-12-01");
                    const endDate = new Date("2026-01-31");
                    const allCusts = Object.entries(customers.value);

                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dStr = d.toISOString().split('T')[0];
                        let jsDay = d.getDay(); 
                        let pIdx = jsDay === 0 ? 6 : jsDay - 1; 

                        allCusts.forEach(([id, data]) => {
                            const start = pIdx * 5;
                            const items = {
                                original: data.pattern[start],
                                sweet: data.pattern[start+1],
                                choco: data.pattern[start+2],
                                strawberry: data.pattern[start+3],
                                brown: data.pattern[start+4]
                            };
                            if (Object.values(items).reduce((a,b)=>a+b,0) > 0) {
                                updates[`daily_operations/${dStr}/${id}`] = {
                                    name: data.name, order: data.order, area: data.area,
                                    items: items, status: 'pending', note: ''
                                };
                            }
                        });
                    }
                    await window.dbUpdate(window.dbRef(window.db), updates);
                    loading.value = false;
                    alert("12æœˆèˆ‡1æœˆé…é€å–®å·²ç”¢ç”ŸæˆåŠŸï¼");
                }

                // --- é…é€å“¡é‚è¼¯ ---
                function loadDailyData(date) {
                    const dRef = window.dbRef(window.db, `daily_operations/${date}`);
                    window.dbOnValue(dRef, (snapshot) => {
                        dailyData.value = snapshot.val() || {};
                    });
                }

                // --- è¼”åŠ©å·¥å…· ---
                const sortedCustomers = computed(() => {
                    return Object.entries(customers.value)
                        .map(([id, data]) => ({ id, ...data }))
                        .sort((a,b) => a.order - b.order);
                });

                const sortedDailyList = computed(() => {
                    return Object.entries(dailyData.value)
                        .map(([id, data]) => ({ id, ...data }))
                        .sort((a,b) => a.order - b.order);
                });

                const getDayTotal = (pattern, dayIdx) => {
                    const start = dayIdx * 5;
                    return pattern.slice(start, start + 5).reduce((a,b)=>a+b, 0);
                };

                const toggleStatus = (item) => {
                    const newStatus = item.status === 'delivered' ? 'pending' : 'delivered';
                    window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${item.id}`), { status: newStatus });
                };

                const updateNote = (item) => {
                    window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${item.id}`), { note: item.note });
                };

                const changeDate = (n) => {
                    const d = new Date(selectedDate.value);
                    d.setDate(d.getDate() + n);
                    selectedDate.value = d.toISOString().split('T')[0];
                    loadDailyData(selectedDate.value);
                };

                const getFlavorName = (k) => ({ original:'åŸ', sweet:'ç”œ', choco:'å·§', strawberry:'è“', brown:'é»‘' }[k]);
                const getFlavorClass = (k) => ({
                    original: 'bg-blue-100 text-blue-700',
                    sweet: 'bg-pink-100 text-pink-700',
                    choco: 'bg-amber-100 text-amber-800',
                    strawberry: 'bg-red-100 text-red-700',
                    brown: 'bg-yellow-100 text-yellow-800'
                }[k]);
                const getWeekDay = (d) => ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][new Date(d).getDay()];

                return {
                    currentView, selectedDate, sheetUrl, loading, customers, sortedCustomers,
                    sortedDailyList, syncFromSheet, generateDailyLogs, getDayTotal,
                    toggleStatus, updateNote, changeDate, getFlavorName, getFlavorClass, getWeekDay
                };
            }
        }).mount('#app');
    </script>
</body>
</html>