<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>咩咩配送 CRM V11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --safe-bottom: 34px; }
        body { background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .ios-content { height: calc(100vh - 160px); overflow-y: auto; padding-bottom: 150px; }
        
        .state-ready { background-color: #e0e7ff !important; color: #4338ca; border: 2px dashed #6366f1 !important; } 
        .state-success { background-color: #22c55e !important; color: white; } 
        .state-leave { background-color: #1e293b !important; color: white; }   
        .state-fail { background-color: #ef4444 !important; color: white; }    
        
        .day-cell { min-height: 64px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; position: relative; }
        .flavor-tag { font-size: 9px; line-height: 1.1; opacity: 0.9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="app" class="max-w-[430px] mx-auto min-h-screen bg-slate-50 relative shadow-2xl overflow-hidden">
        
        <header class="bg-white p-4 sticky top-0 z-30 border-b border-slate-200 flex justify-between items-center">
            <h1 class="text-xl font-black text-indigo-700 italic">GOAT <span class="text-slate-800 text-sm">V11</span></h1>
            <div class="flex gap-2">
                <span v-if="activeTab === 'B'" class="bg-indigo-600 text-white px-3 py-1 rounded-full text-[10px] font-bold">準貨模式</span>
                <span v-else class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-[10px] font-bold">配送模式</span>
            </div>
        </header>

        <main class="ios-content">
            
            <div v-if="activeTab === 'A'" class="p-3">
                <div class="flex overflow-x-auto gap-2 mb-4 no-scrollbar pb-1">
                    <button v-for="b in blocks" @click="selectedBlock = b"
                        :class="['whitespace-nowrap px-5 py-2 rounded-full text-xs font-bold transition-all', selectedBlock === b ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-200']">
                        {{ b }}
                    </button>
                </div>

                <div class="bg-white rounded-2xl p-2 mb-4 shadow-sm border border-slate-200 flex overflow-x-auto gap-2 no-scrollbar">
                    <button v-for="c in filteredCustomers" @click="selectedCid = c.id"
                        :class="['whitespace-nowrap px-4 py-3 rounded-xl text-sm font-bold', selectedCid === c.id ? 'bg-slate-800 text-white' : 'text-slate-500']">
                        {{ c.name }}
                    </button>
                </div>

                <div v-if="currentCustomer" class="flex items-center justify-between px-2 mb-4">
                    <button @click="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 rounded-full text-slate-400 shadow-sm"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="text-lg font-black text-slate-700">{{ viewMonthLabel }}</div>
                    <button @click="changeMonth(1)" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 rounded-full text-slate-400 shadow-sm"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div v-if="currentCustomer" class="animate-fade-in">
                    <div class="bg-indigo-700 text-white p-5 rounded-[2rem] shadow-lg mb-6 flex justify-between items-end relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-[10px] font-black opacity-60 uppercase mb-1">{{ currentCustomer.block }} 路段</div>
                            <div class="text-2xl font-black mb-1">{{ currentCustomer.name }}</div>
                            <div class="text-xs opacity-80">{{ currentCustomer.note || '無特殊備註' }}</div>
                        </div>
                        <div class="text-right relative z-10">
                            <div class="text-[10px] font-bold opacity-60 uppercase">本月結算</div>
                            <div class="text-3xl font-black">${{ currentMonthTotal }}</div>
                        </div>
                        <i class="fa-solid fa-calendar-check absolute -right-4 -bottom-4 text-7xl opacity-10"></i>
                    </div>

                    <div class="bg-white rounded-[2.5rem] p-3 shadow-sm border border-slate-200">
                        <div class="grid grid-cols-7 gap-1">
                            <div v-for="d in ['一','二','三','四','五','六','日']" class="text-center text-[10px] text-slate-300 font-bold py-2">{{ d }}</div>
                            
                            <div v-for="day in calendarDays" :key="day.dateKey" 
                                @click="day.date && handleDayInteraction(selectedCid, day.dateKey)"
                                :class="['day-cell', day.date ? 'bg-slate-50 shadow-sm' : 'bg-transparent', getStatusClass(selectedCid, day.dateKey)]">
                                <span>{{ day.date }}</span>
                                <div v-if="day.date && (logs[selectedCid]?.[day.dateKey] === 'S' || (!logs[selectedCid]?.[day.dateKey] && isExpectedDay(selectedCid, day.dateKey)))" 
                                     class="flavor-tag font-black text-center mt-1">
                                    {{ getFlavorPreview(selectedCid) }}
                                </div>
                                <i v-if="logs[selectedCid]?.[day.dateKey] === 'L'" class="fa-solid fa-xmark absolute text-white/30 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'B'" class="p-4 space-y-4">
                <div class="flex overflow-x-auto gap-2 mb-4 no-scrollbar py-2">
                    <button v-for="n in 10" @click="prepOffset = n-1"
                        :class="['whitespace-nowrap px-5 py-3 rounded-2xl font-bold text-sm transition-all', prepOffset === n-1 ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-400 border border-slate-100']">
                        {{ getPrepDateLabel(n-1) }}
                    </button>
                </div>

                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm">
                    <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-box-open text-indigo-500"></i>
                        {{ getPrepDateFull(prepOffset) }} 備貨總計
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div v-for="(count, f) in prepSummary" :key="f" 
                             v-show="count > 0"
                             class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div class="text-[10px] font-bold text-slate-400 uppercase">{{ f }}</div>
                            <div class="text-2xl font-black text-slate-700">{{ count }} <span class="text-xs">瓶</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'C'" class="p-4">
                <button @click="openEdit(null)" class="w-full py-5 bg-white border-2 border-dashed border-slate-200 rounded-[2rem] text-slate-400 font-black mb-6">
                    + 新增訂戶資料
                </button>
                <div v-for="c in customers" @click="openEdit(c)" class="bg-white p-5 rounded-3xl border border-slate-200 mb-3 flex justify-between items-center">
                    <div>
                        <div class="font-black text-lg text-slate-800">{{ c.name }}</div>
                        <div class="text-xs text-indigo-500 font-bold uppercase">{{ c.block }} 路段</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-black text-slate-700">{{ c.count }}瓶</div>
                        <div class="text-[10px] text-slate-300">{{ c.plan }}</div>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end justify-center bg-slate-900/60 backdrop-blur-sm">
            <div class="bg-white w-full max-w-[430px] rounded-t-[2.5rem] p-8 space-y-6 animate-slide-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-black">{{ form.id ? '資料維護' : '新訂戶' }}</h2>
                    <button @click="showModal = false" class="w-10 h-10 bg-slate-100 rounded-full">&times;</button>
                </div>
                
                <div class="space-y-4">
                    <section class="space-y-3">
                        <div class="flex gap-2">
                            <input v-model="form.name" type="text" placeholder="1.7 姓名" class="flex-1 bg-slate-50 border p-4 rounded-2xl font-bold">
                            <input v-model="form.phone" type="tel" placeholder="1.6 電話" class="flex-1 bg-slate-50 border p-4 rounded-2xl font-bold">
                        </div>
                        <select v-model="form.block" class="w-full bg-slate-50 border p-4 rounded-2xl font-bold">
                            <option v-for="b in blocks" :value="b">{{ b }} 路段</option>
                        </select>
                        <select v-model="form.plan" class="w-full bg-slate-50 border p-4 rounded-2xl font-bold">
                            <option v-for="(v, k) in plans" :value="k">{{ v }}</option>
                        </select>
                        <input v-model="form.note" type="text" placeholder="1.5 收款要求" class="w-full bg-slate-50 border p-4 rounded-2xl font-bold">
                    </section>

                    <section class="bg-slate-50 p-5 rounded-3xl border border-slate-100">
                        <h3 class="text-sm font-black text-slate-400 mb-4 uppercase tracking-widest">口味預設 (總瓶數: {{ flavorFormTotal }})</h3>
                        <div class="space-y-3">
                            <div v-for="f in flavors" :key="f" class="flex justify-between items-center">
                                <span class="font-bold text-slate-600 text-sm">{{ f }}</span>
                                <div class="flex items-center gap-3">
                                    <button @click="form.flavorConfig[f] = Math.max(0, form.flavorConfig[f]-1)" class="w-8 h-8 bg-white border rounded-full">-</button>
                                    <span class="font-black w-4 text-center">{{ form.flavorConfig[f] }}</span>
                                    <button @click="form.flavorConfig[f]++" class="w-8 h-8 bg-white border rounded-full">+</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="flex gap-3">
                    <button @click="submitCustomer" class="flex-1 bg-indigo-600 text-white py-5 rounded-3xl font-black shadow-lg active:scale-95 transition-transform">儲存同步</button>
                    <button v-if="form.id" @click="deleteCustomer" class="w-16 bg-red-50 text-red-500 rounded-3xl flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-[430px] bg-white border-t border-slate-100 px-10 pt-3 pb-[var(--safe-bottom)] flex justify-between z-40">
            <button @click="activeTab = 'A'" :class="['flex flex-col items-center gap-1', activeTab === 'A' ? 'text-indigo-600' : 'text-slate-300']">
                <i class="fa-solid fa-calendar-check text-xl"></i>
                <span class="text-[10px] font-bold">配送日曆</span>
            </button>
            <button @click="activeTab = 'B'" :class="['flex flex-col items-center gap-1', activeTab === 'B' ? 'text-indigo-600' : 'text-slate-300']">
                <i class="fa-solid fa-dolly text-xl"></i>
                <span class="text-[10px] font-bold">準貨清單</span>
            </button>
            <button @click="activeTab = 'C'" :class="['flex flex-col items-center gap-1', activeTab === 'C' ? 'text-indigo-600' : 'text-slate-300']">
                <i class="fa-solid fa-users-gear text-xl"></i>
                <span class="text-[10px] font-bold">訂戶管理</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:aac47eb5a7cba165dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const { createApp, ref, reactive, computed, onMounted } = Vue;

        createApp({
            setup() {
                const activeTab = ref('A');
                const selectedBlock = ref('大埔');
                const selectedCid = ref('');
                const currentViewDate = ref(new Date()); // 用於月份切換
                const prepOffset = ref(0);
                const showModal = ref(false);

                const customers = ref([]);
                const logs = reactive({});
                const flavors = ['原味','甜味','黑糖','巧克力','草莓'];
                const blocks = ['大埔', '中園街', '橫溪', '大同路', '恩主公', '大勇路', '市場', '長泰街', '復興路', '民生路'];
                const plans = { 
                    'A':'每天送', 'B':'週一到週五', 'C':'週二到週日', 'D':'週一+週三+週五', 
                    'E':'週三+週五', 'F':'週二+週四', 'G':'週二到週五', 'H':'週六', 'J':'週六+週日', 'K':'週一到週四' 
                };

                const form = reactive({ id: null, name: '', block: '大埔', count: 0, plan: 'A', phone: '', note: '', flavorConfig: {} });

                onMounted(() => {
                    onSnapshot(collection(db, "customers"), snap => {
                        customers.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                    onSnapshot(collection(db, "delivery_logs"), snap => {
                        snap.forEach(d => {
                            const [cid, date] = d.id.split('_');
                            if (!logs[cid]) logs[cid] = {};
                            logs[cid][date] = d.data().status;
                        });
                    });
                });

                // --- 月份導覽 ---
                const changeMonth = (delta) => {
                    const d = new Date(currentViewDate.value);
                    d.setMonth(d.getMonth() + delta);
                    currentViewDate.value = d;
                };

                const viewMonthLabel = computed(() => {
                    return currentViewDate.value.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });
                });

                const calendarDays = computed(() => {
                    const y = currentViewDate.value.getFullYear();
                    const m = currentViewDate.value.getMonth();
                    const firstDay = new Date(y, m, 1).getDay();
                    const adjustedFirst = (firstDay === 0) ? 6 : firstDay - 1;
                    const total = new Date(y, m + 1, 0).getDate();
                    const days = [];
                    for (let i = 0; i < adjustedFirst; i++) days.push({ date: null });
                    for (let i = 1; i <= total; i++) {
                        const dk = `${y}-${String(m + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        days.push({ date: i, dateKey: dk });
                    }
                    return days;
                });

                // --- 配送與口味邏輯 ---
                const isExpectedDay = (cid, dateKey) => {
                    const c = customers.value.find(x => x.id === cid);
                    if (!c) return false;
                    const day = new Date(dateKey).getDay();
                    const p = c.plan;
                    const map = { 'A':[0,1,2,3,4,5,6], 'B':[1,2,3,4,5], 'C':[0,2,3,4,5,6], 'D':[1,3,5], 'E':[3,5], 'F':[2,4], 'G':[2,3,4,5], 'H':[6], 'J':[0,6], 'K':[1,2,3,4] };
                    return map[p]?.includes(day);
                };

                const getFlavorPreview = (cid) => {
                    const c = customers.value.find(x => x.id === cid);
                    if (!c || !c.flavorConfig) return '';
                    return Object.entries(c.flavorConfig)
                        .filter(([f, n]) => n > 0)
                        .map(([f, n]) => `${f[0]}${n}`)
                        .join(',');
                };

                const handleDayInteraction = async (cid, dateKey) => {
                    const current = logs[cid]?.[dateKey];
                    let next = null;
                    if (!current) next = 'S';
                    else if (current === 'S') next = 'L';
                    else if (current === 'L') next = 'F';
                    else next = null;

                    const logId = `${cid}_${dateKey}`;
                    if (next) await setDoc(doc(db, "delivery_logs", logId), { status: next });
                    else await deleteDoc(doc(db, "delivery_logs", logId));
                };

                const getStatusClass = (cid, dateKey) => {
                    const s = logs[cid]?.[dateKey];
                    if (s === 'S') return 'state-success';
                    if (s === 'L') return 'state-leave';
                    if (s === 'F') return 'state-fail';
                    if (isExpectedDay(cid, dateKey)) return 'state-ready';
                    return 'bg-white';
                };

                // --- 準貨統計 (依照預設口味) ---
                const prepSummary = computed(() => {
                    const targetDate = new Date();
                    targetDate.setDate(targetDate.getDate() + prepOffset.value);
                    const targetKey = targetDate.toISOString().split('T')[0];
                    const summary = { '原味':0, '甜味':0, '黑糖':0, '巧克力':0, '草莓':0 };
                    
                    customers.value.forEach(c => {
                        const status = logs[c.id]?.[targetKey];
                        const expected = isExpectedDay(c.id, targetKey);
                        if ((expected && status !== 'L') || status === 'S') {
                            if (c.flavorConfig) {
                                Object.entries(c.flavorConfig).forEach(([f, n]) => summary[f] += n);
                            }
                        }
                    });
                    return summary;
                });

                const prepList = computed(() => {
                    const targetDate = new Date(); targetDate.setDate(targetDate.getDate() + prepOffset.value);
                    const targetKey = targetDate.toISOString().split('T')[0];
                    return customers.value.filter(c => {
                        const s = logs[c.id]?.[targetKey];
                        return (isExpectedDay(c.id, targetKey) && s !== 'L') || s === 'S';
                    });
                });

                // --- CRUD ---
                const openEdit = (c) => {
                    if (c) {
                        Object.assign(form, JSON.parse(JSON.stringify(c)));
                    } else {
                        Object.assign(form, { id: null, name: '', block: '大埔', count: 0, plan: 'A', phone: '', note: '' });
                        flavors.forEach(f => form.flavorConfig[f] = 0);
                        form.flavorConfig['原味'] = 1; // 預設 1 瓶原味
                    }
                    showModal.value = true;
                };

                const flavorFormTotal = computed(() => Object.values(form.flavorConfig || {}).reduce((a, b) => a + b, 0));

                const submitCustomer = async () => {
                    form.count = flavorFormTotal.value; // 自動同步總瓶數
                    if (form.id) await setDoc(doc(db, "customers", form.id), { ...form });
                    else await addDoc(collection(db, "customers"), { ...form });
                    showModal.value = false;
                };

                const currentMonthTotal = computed(() => {
                    const c = currentCustomer.value;
                    if (!c || !logs[selectedCid.value]) return 0;
                    const successCount = Object.values(logs[selectedCid.value]).filter(s => s === 'S').length;
                    return successCount * c.count * 30;
                });

                return { 
                    activeTab, selectedBlock, selectedCid, customers, filteredCustomers, currentCustomer, 
                    logs, handleDayInteraction, getStatusClass, blocks, plans, prepOffset, prepList, 
                    showModal, form, openEdit, submitCustomer, currentMonthTotal, calendarDays,
                    changeMonth, viewMonthLabel, flavors, flavorFormTotal, getFlavorPreview, prepSummary,
                    getPrepDateLabel: (o) => { const d = new Date(); d.setDate(d.getDate() + o); return o === 0 ? '今天' : o === 1 ? '明天' : (d.getMonth()+1) + '/' + d.getDate(); },
                    getPrepDateFull: (o) => { const d = new Date(); d.setDate(d.getDate() + o); return d.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' }); }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>