<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>配送員助手 V7 - 街區分流版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --safe-bottom: 34px; }
        body { background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .ios-content { height: calc(100vh - 160px); overflow-y: auto; padding-bottom: 150px; }
        /* 日曆狀態色 */
        .state-leave { background-color: #f97316 !important; color: white; } 
        .state-fail { background-color: #ef4444 !important; color: white; }  
        .state-success { background-color: #22c55e !important; color: white; } 
        /* 方案預期配送日 - 虛線框 */
        .is-expected { border: 2px dashed #6366f1 !important; }
        .day-cell { min-height: 52px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; }
    </style>
</head>
<body>

    <div id="app" class="max-w-[430px] mx-auto min-h-screen bg-slate-50 relative">
        
        <header class="bg-white p-4 sticky top-0 z-30 border-b border-slate-200">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-black text-slate-800">{{ tabTitles[activeTab] }}</h1>
                <div v-if="activeTab === 'A'" class="flex gap-2">
                    <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-bold">街區作業</span>
                </div>
            </div>
        </header>

        <main class="ios-content">
            
            <div v-if="activeTab === 'A'" class="p-3">
                <div class="flex overflow-x-auto gap-2 mb-4 no-scrollbar pb-2">
                    <button v-for="b in blocks" @click="selectedBlock = b"
                        :class="['whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all', selectedBlock === b ? 'bg-indigo-600 text-white' : 'bg-white text-slate-400 border border-slate-200']">
                        {{ b }}
                    </button>
                </div>

                <div class="bg-white rounded-2xl p-2 mb-4 shadow-sm border border-slate-200">
                    <div class="flex overflow-x-auto gap-2 no-scrollbar">
                        <button v-for="c in filteredCustomers" @click="selectedCid = c.id"
                            :class="['whitespace-nowrap px-4 py-3 rounded-xl text-sm font-bold', selectedCid === c.id ? 'bg-slate-800 text-white' : 'text-slate-500']">
                            {{ c.name }}
                        </button>
                    </div>
                </div>

                <div v-if="currentCustomer" class="animate-fade-in">
                    <div class="bg-indigo-50 p-3 rounded-2xl mb-4 border border-indigo-100 flex justify-between items-center">
                        <div>
                            <div class="text-xs text-indigo-400 font-bold">配送方案：{{ currentCustomer.plan }}</div>
                            <div class="text-sm font-black text-indigo-900">{{ currentCustomer.note }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-slate-400 font-bold">本月金額</div>
                            <div class="text-xl font-black text-indigo-600">${{ currentMonthTotal }}</div>
                        </div>
                    </div>

                    <div v-for="month in renderedMonths" :key="month.month" class="bg-white rounded-3xl p-2 shadow-sm border border-slate-200 mb-6">
                        <div class="text-center font-black py-2 text-slate-700">{{ month.year }}年 {{ month.month + 1 }}月</div>
                        <div class="grid grid-cols-7 gap-1">
                            <div v-for="d in ['日','一','二','三','四','五','六']" class="text-center text-[10px] text-slate-300 font-bold py-1">{{ d }}</div>
                            <div v-for="day in month.days" :key="day.dateKey" 
                                @click="day.date && toggleStatus(selectedCid, day.dateKey)"
                                :class="['day-cell', day.date ? 'bg-slate-50' : 'bg-transparent', getStatusClass(selectedCid, day.dateKey), (day.date && isExpectedDay(selectedCid, day.dateKey)) ? 'is-expected' : '']">
                                {{ day.date }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'B'" class="p-4 space-y-4">
                <div class="flex items-center gap-2 mb-4 overflow-x-auto no-scrollbar py-2">
                    <button v-for="n in 11" @click="prepOffset = n-1"
                        :class="['whitespace-nowrap px-4 py-2 rounded-xl font-bold text-xs', prepOffset === n-1 ? 'bg-slate-800 text-white' : 'bg-white text-slate-400']">
                        {{ getPrepDateLabel(n-1) }}
                    </button>
                </div>

                <div class="bg-indigo-600 text-white p-6 rounded-3xl shadow-lg mb-6">
                    <div class="text-sm opacity-80 mb-1">{{ getPrepDateFull(prepOffset) }} 總計</div>
                    <div class="text-5xl font-black">{{ prepTotalCount }} <span class="text-xl">瓶</span></div>
                </div>

                <div v-for="item in prepList" :key="item.id" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-slate-800">{{ item.name }}</div>
                        <div class="text-xs text-slate-400">{{ item.block }} | {{ item.phone }}</div>
                    </div>
                    <div class="text-xl font-black text-slate-700">x{{ item.count }}</div>
                </div>
            </div>

            <div v-if="activeTab === 'C'" class="p-4">
                <button @click="openEdit(null)" class="w-full py-4 bg-white border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold mb-4">
                    + 新增客戶資料
                </button>
                <div v-for="c in customers" @click="openEdit(c)" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-2 flex justify-between items-center">
                    <div>
                        <div class="font-bold">{{ c.name }}</div>
                        <div class="text-xs text-slate-400">{{ c.block }} / 方案 {{ c.plan }}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-200"></i>
                </div>
            </div>

        </main>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm">
            <div class="bg-white w-full max-w-[430px] rounded-t-3xl p-6 space-y-4 animate-slide-up shadow-2xl">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-black">{{ form.id ? '編輯客戶' : '新增客戶' }}</h2>
                    <button @click="showModal = false" class="text-slate-300 text-2xl">&times;</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">顧客姓名</label>
                        <input v-model="form.name" type="text" class="w-full bg-slate-100 p-3 rounded-xl">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">街區設定</label>
                        <select v-model="form.block" class="w-full bg-slate-100 p-3 rounded-xl">
                            <option v-for="b in blocks" :value="b">{{ b }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">配送方案</label>
                        <select v-model="form.plan" class="w-full bg-slate-100 p-3 rounded-xl">
                            <option v-for="(v, k) in plans" :value="k">{{ k }}. {{ v }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">配送數量</label>
                        <select v-model="form.count" class="w-full bg-slate-100 p-3 rounded-xl">
                            <option v-for="n in [1,2,3,4]" :value="n">{{ n }} 瓶</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">聯繫方式</label>
                        <input v-model="form.phone" type="text" class="w-full bg-slate-100 p-3 rounded-xl">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">收款要求 / 備註</label>
                        <input v-model="form.note" type="text" class="w-full bg-slate-100 p-3 rounded-xl">
                    </div>
                </div>
                <button @click="submitCustomer" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-lg shadow-indigo-100">儲存變更</button>
                <button v-if="form.id" @click="deleteCustomer" class="w-full py-2 text-red-400 font-bold text-sm">刪除客戶資料</button>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-[430px] bg-white/90 backdrop-blur-xl border-t border-slate-200 px-6 pt-3 pb-[var(--safe-bottom)] flex justify-between z-40">
            <button @click="activeTab = 'A'" :class="['flex flex-col items-center gap-1', activeTab === 'A' ? 'text-indigo-600' : 'text-slate-300']">
                <i class="fa-solid fa-map-location-dot text-xl"></i>
                <span class="text-[10px] font-bold">街區日曆</span>
            </button>
            <button @click="activeTab = 'B'" :class="['flex flex-col items-center gap-1', activeTab === 'B' ? 'text-indigo-600' : 'text-slate-300']">
                <i class="fa-solid fa-truck-ramp-box text-xl"></i>
                <span class="text-[10px] font-bold">準貨內容</span>
            </button>
            <button @click="activeTab = 'C'" :class="['flex flex-col items-center gap-1', activeTab === 'C' ? 'text-indigo-600' : 'text-slate-300']">
                <i class="fa-solid fa-users-gear text-xl"></i>
                <span class="text-[10px] font-bold">訂戶管理</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:aac47eb5a7cba165dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const { createApp, ref, reactive, computed, onMounted } = Vue;

        createApp({
            setup() {
                const activeTab = ref('A');
                const selectedBlock = ref('大埔');
                const selectedCid = ref('');
                const prepOffset = ref(0);
                const currentRange = ref(1);
                const showModal = ref(false);

                const customers = ref([]);
                const logs = reactive({});

                const blocks = ['大埔', '中園街', '橫溪', '大同路', '恩主公', '大勇路', '市場', '長泰街', '復興路', '民生路'];
                const plans = { 'A':'每天送', 'B':'週一到週五', 'C':'週二到週日', 'D':'週一+週三+週五', 'E':'週三+週五', 'F':'週二+週四', 'G':'週二到週五', 'H':'週六', 'J':'週六+週日' };
                const tabTitles = { 'A': '街區配送日曆', 'B': '準貨量統計', 'C': '訂戶 CRM' };

                const form = reactive({ id: null, name: '', block: '大埔', count: 1, plan: 'A', phone: '', note: '' });

                // --- Firebase 同步 ---
                onMounted(() => {
                    onSnapshot(collection(db, "customers"), snap => {
                        customers.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (customers.value.length > 0 && !selectedCid.value) selectedCid.value = customers.value[0].id;
                    });
                    onSnapshot(collection(db, "delivery_logs"), snap => {
                        snap.forEach(d => {
                            const [cid, date] = d.id.split('_');
                            if (!logs[cid]) logs[cid] = {};
                            logs[cid][date] = d.data().status;
                        });
                    });
                });

                // --- 核心邏輯：方案判定 ---
                const isExpectedDay = (cid, dateKey) => {
                    const c = customers.value.find(x => x.id === cid);
                    if (!c) return false;
                    const day = new Date(dateKey).getDay();
                    const p = c.plan;
                    if (p === 'A') return true;
                    if (p === 'B') return day >= 1 && day <= 5;
                    if (p === 'C') return day !== 1;
                    if (p === 'D') return [1,3,5].includes(day);
                    if (p === 'E') return [3,5].includes(day);
                    if (p === 'F') return [2,4].includes(day);
                    if (p === 'G') return day >= 2 && day <= 5;
                    if (p === 'H') return day === 6;
                    if (p === 'J') return day === 0 || day === 6;
                    return false;
                };

                // --- 準貨清單計算 ---
                const prepList = computed(() => {
                    const targetDate = new Date();
                    targetDate.setDate(targetDate.getDate() + prepOffset.value);
                    const targetKey = targetDate.toISOString().split('T')[0];
                    return customers.value.filter(c => isExpectedDay(c.id, targetKey));
                });

                const prepTotalCount = computed(() => prepList.value.reduce((sum, c) => sum + parseInt(c.count), 0));

                // --- 街區過濾 ---
                const filteredCustomers = computed(() => customers.value.filter(c => c.block === selectedBlock.value));
                const currentCustomer = computed(() => customers.value.find(c => c.id === selectedCid.value));

                // --- 狀態切換 ---
                const toggleStatus = async (cid, dateKey) => {
                    const current = logs[cid]?.[dateKey];
                    let next = 'S'; // 已送
                    if (current === 'S') next = 'L'; // 請假
                    else if (current === 'L') next = 'F'; // 未送
                    else if (current === 'F') next = null;

                    const logId = `${cid}_${dateKey}`;
                    if (next) await setDoc(doc(db, "delivery_logs", logId), { status: next });
                    else await deleteDoc(doc(db, "delivery_logs", logId));
                };

                const getStatusClass = (cid, dateKey) => {
                    const s = logs[cid]?.[dateKey];
                    return s === 'S' ? 'state-success' : s === 'L' ? 'state-leave' : s === 'F' ? 'state-fail' : '';
                };

                // --- 工具函數 ---
                const getPrepDateLabel = (offset) => {
                    const d = new Date(); d.setDate(d.getDate() + offset);
                    if (offset === 0) return '今天';
                    if (offset === 1) return '明天';
                    return (d.getMonth()+1) + '/' + d.getDate();
                };

                const getPrepDateFull = (offset) => {
                    const d = new Date(); d.setDate(d.getDate() + offset);
                    return d.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' });
                };

                // --- CRUD ---
                const openEdit = (c) => {
                    if (c) Object.assign(form, c);
                    else Object.assign(form, { id: null, name: '', block: '大埔', count: 1, plan: 'A', phone: '', note: '' });
                    showModal.value = true;
                };

                const submitCustomer = async () => {
                    if (form.id) await setDoc(doc(db, "customers", form.id), { ...form });
                    else await addDoc(collection(db, "customers"), { ...form });
                    showModal.value = false;
                };

                const deleteCustomer = async () => {
                    if (confirm("刪除訂戶？")) {
                        await deleteDoc(doc(db, "customers", form.id));
                        showModal.value = false;
                    }
                };

                const currentMonthTotal = computed(() => {
                    if (!currentCustomer.value || !logs[selectedCid.value]) return 0;
                    const successCount = Object.values(logs[selectedCid.value]).filter(s => s === 'S').length;
                    return successCount * currentCustomer.value.count * 30;
                });

                // 月曆生成
                const renderedMonths = computed(() => {
                    const ms = []; const today = new Date();
                    for (let i = 0; i < currentRange.value; i++) {
                        const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                        ms.push({ year: d.getFullYear(), month: d.getMonth(), days: generateDays(d.getFullYear(), d.getMonth()) });
                    }
                    return ms;
                });

                function generateDays(y, m) {
                    const first = new Date(y, m, 1).getDay();
                    const total = new Date(y, m + 1, 0).getDate();
                    const days = [];
                    for (let i = 0; i < first; i++) days.push({ date: null });
                    for (let i = 1; i <= total; i++) {
                        const dk = `${y}-${String(m + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        days.push({ date: i, dateKey: dk });
                    }
                    return days;
                }

                return { 
                    activeTab, selectedBlock, selectedCid, customers, filteredCustomers, currentCustomer, 
                    logs, toggleStatus, getStatusClass, isExpectedDay, blocks, plans, tabTitles,
                    prepOffset, prepList, prepTotalCount, getPrepDateLabel, getPrepDateFull,
                    showModal, form, openEdit, submitCustomer, deleteCustomer, currentMonthTotal,
                    renderedMonths, currentRange
                };
            }
        }).mount('#app');
    </script>
</body>
</html>