<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é…é€å“¡åŠ©æ‰‹ - iPhone 15 å¯¦æ©Ÿä»‹é¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* iPhone 15 è¢å¹•é©é…èˆ‡è§¸æ§å„ªåŒ– */
        :root { --safe-area-bottom: 34px; }
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tab-content { height: calc(100vh - 150px); overflow-y: auto; padding-bottom: 100px; }
        .iphone-card { @apply bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4; }
        .input-group label { @apply block text-xs font-bold text-slate-400 mb-1 uppercase; }
        .input-style { @apply w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:border-indigo-500 focus:bg-white outline-none transition-all; }
    </style>
</head>
<body>

    <div id="app" class="max-w-[430px] mx-auto min-h-screen relative shadow-2xl bg-slate-50">
        
        <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-20">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-black text-indigo-700 italic">GOAT <span class="text-slate-800">DELIVERY</span></h1>
                <span class="text-xs font-bold bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full">iPhone 15 Mode</span>
            </div>
        </header>

        <main class="tab-content p-4">
            
            <div v-if="activeTab === 'A'" class="animate-fade-in-up">
                <div class="iphone-card">
                    <h2 class="font-bold text-lg mb-4 text-slate-800">å®¢æˆ¶é…é€ç™»è¨˜</h2>
                    
                    <div class="space-y-4">
                        <div class="input-group">
                            <label>èµ·å§‹æ—¥æœŸ</label>
                            <input type="date" v-model="form.startDate" class="input-style">
                        </div>

                        <div class="grid grid-cols-3 gap-2">
                            <button v-for="w in [4, 5, 8]" @click="form.weeks = w"
                                :class="['py-2 rounded-lg font-bold border-2 transition-all', form.weeks === w ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-slate-100 bg-slate-50 text-slate-400']">
                                {{ w }} é€±
                            </button>
                        </div>

                        <hr class="my-4">

                        <div class="input-group">
                            <label>è¡—å€ç·¨è™Ÿ</label>
                            <select v-model="form.blockId" class="input-style">
                                <option value="å¤§åŸ”è·¯æ®µ">å¤§åŸ”è·¯æ®µ (é è¨­)</option>
                                <option value="å¸‚ä¸­å¿ƒå€">å¸‚ä¸­å¿ƒå€</option>
                                <option value="å·¥æ¥­åœ’å€">å·¥æ¥­åœ’å€</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="input-group">
                                <label>å®¢æˆ¶å§“å</label>
                                <input type="text" v-model="form.name" placeholder="è«‹è¼¸å…¥å§“å" class="input-style">
                            </div>
                            <div class="input-group">
                                <label>é›»è©±</label>
                                <input type="tel" v-model="form.phone" placeholder="09xx..." class="input-style">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>è©³ç´°åœ°å€</label>
                            <input type="text" v-model="form.address" placeholder="è¡—é“é–€ç‰Œ" class="input-style">
                        </div>

                        <div class="input-group">
                            <label>å£å‘³é¸æ“‡</label>
                            <input type="text" v-model="form.flavor" placeholder="ä¾‹å¦‚ï¼šåŸå‘³ã€ä½è„‚" class="input-style">
                        </div>
                    </div>
                </div>

                <div class="iphone-card bg-slate-900 border-none">
                    <label class="text-indigo-400 text-xs font-bold mb-2 block">é è¦½ç´€éŒ„ğŸ“</label>
                    <pre class="text-emerald-400 text-sm font-mono whitespace-pre-wrap leading-relaxed">{{ previewText }}</pre>
                    <button @click="saveAndCopy" :disabled="loading"
                        class="w-full mt-4 bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        <i v-if="!loading" class="fa-solid fa-cloud-arrow-up"></i>
                        <i v-else class="fa-solid fa-spinner animate-spin"></i>
                        {{ loading ? 'åŒæ­¥ä¸­...' : 'å­˜æª”ä¸¦è¤‡è£½å…§å®¹' }}
                    </button>
                </div>
            </div>

            <div v-if="activeTab === 'B'" class="space-y-3">
                <h2 class="font-bold text-lg mb-2 px-2">æ­·å²ç´€éŒ„</h2>
                <div v-if="history.length === 0" class="text-center py-20 text-slate-400 italic">å°šæœªæœ‰ç´€éŒ„...</div>
                <div v-for="item in history" :key="item.id" class="iphone-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-black text-slate-800">{{ item.name }}</div>
                            <div class="text-xs text-slate-500">{{ item.blockId }} | {{ item.flavor }}</div>
                        </div>
                        <div class="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">{{ item.date_start }}</div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'C'" class="flex flex-col items-center justify-center h-full text-slate-400 italic">
                <i class="fa-solid fa-calculator text-5xl mb-4 opacity-20"></i>
                ç°¡å–®ä¼°åƒ¹åŠŸèƒ½é–‹ç™¼ä¸­...
            </div>
            <div v-if="activeTab === 'D'" class="flex flex-col items-center justify-center h-full text-slate-400 italic">
                <i class="fa-solid fa-bell-slash text-5xl mb-4 opacity-20"></i>
                åœé€æ‘˜è¦åŠŸèƒ½é–‹ç™¼ä¸­...
            </div>

        </main>

        <nav class="fixed bottom-0 w-full max-w-[430px] bg-white/80 backdrop-blur-lg border-t border-slate-200 px-6 pt-3 pb-[var(--safe-area-bottom)] z-30">
            <div class="flex justify-between items-center">
                <button @click="activeTab = 'A'" :class="['flex flex-col items-center gap-1', activeTab === 'A' ? 'text-indigo-600' : 'text-slate-400']">
                    <i class="fa-solid fa-calendar-day text-xl"></i>
                    <span class="text-[10px] font-bold">æ—¥æœŸè¨ˆç®—</span>
                </button>
                <button @click="activeTab = 'B'" :class="['flex flex-col items-center gap-1', activeTab === 'B' ? 'text-indigo-600' : 'text-slate-400']">
                    <i class="fa-solid fa-clock-history text-xl"></i>
                    <span class="text-[10px] font-bold">æ­·å²ç´€éŒ„</span>
                </button>
                <button @click="activeTab = 'C'" :class="['flex flex-col items-center gap-1', activeTab === 'C' ? 'text-indigo-600' : 'text-slate-400']">
                    <i class="fa-solid fa-dollar-sign text-xl"></i>
                    <span class="text-[10px] font-bold">ç°¡å–®ä¼°åƒ¹</span>
                </button>
                <button @click="activeTab = 'D'" :class="['flex flex-col items-center gap-1', activeTab === 'D' ? 'text-indigo-600' : 'text-slate-400']">
                    <i class="fa-solid fa-file-lines text-xl"></i>
                    <span class="text-[10px] font-bold">åœé€æ‘˜è¦</span>
                </button>
            </div>
        </nav>

        <div v-if="toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-50">
            {{ toastMsg }}
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:aac47eb5a7cba165dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const { createApp, ref, reactive, computed, onMounted } = Vue;

        createApp({
            setup() {
                const activeTab = ref('A');
                const loading = ref(false);
                const toast = ref(false);
                const toastMsg = ref("");
                const history = ref([]);

                const form = reactive({
                    startDate: new Date().toISOString().substr(0, 10),
                    weeks: 4,
                    blockId: 'å¤§åŸ”è·¯æ®µ',
                    name: '',
                    phone: '',
                    address: '',
                    flavor: ''
                });

                // ç”Ÿæˆé è¦½æ–‡å­—
                const previewText = computed(() => {
                    let text = `æ›´æ–° é…é€ç´€éŒ„ğŸ“\n`;
                    text += `å®¢æˆ¶ï¼š${form.name || '(æœªå¡«)'} / ${form.phone || '(æœªå¡«)'}\n`;
                    text += `åœ°å€ï¼š${form.blockId} ${form.address}\n`;
                    text += `å£å‘³ï¼š${form.flavor}\n`;
                    text += `----------------\næœ€æ–°ä¸€æœŸï¼š\n`;
                    
                    const base = new Date(form.startDate);
                    for (let i = 0; i < form.weeks; i++) {
                        const d = new Date(base);
                        d.setDate(base.getDate() + (i * 7));
                        const mStr = (d.getMonth() + 1).toString().padStart(2, '0');
                        const dStr = d.getDate().toString().padStart(2, '0');
                        let note = (i === form.weeks - 1) ? `ï¼ˆé è¨ˆæ”¶æ¬¾æ—¥ï¼‰` : "";
                        text += `âœ…${mStr}/${dStr}${note}\n`;
                    }
                    return text;
                });

                const saveAndCopy = async () => {
                    loading.value = true;
                    try {
                        // 1. è¤‡è£½åˆ°å‰ªè²¼ç°¿
                        await navigator.clipboard.writeText(previewText.value);

                        // 2. å­˜å…¥ Firebase
                        await addDoc(collection(db, "delivery_records"), {
                            ...form,
                            full_content: previewText.value,
                            created_at: serverTimestamp()
                        });

                        showToast("âœ… å·²å„²å­˜ä¸¦è¤‡è£½å…§å®¹");
                    } catch (e) {
                        showToast("âŒ éŒ¯èª¤: " + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const showToast = (msg) => {
                    toastMsg.value = msg;
                    toast.value = true;
                    setTimeout(() => toast.value = false, 2500);
                };

                // ç›£è½æ­·å²ç´€éŒ„
                onMounted(() => {
                    const q = query(collection(db, "delivery_records"), orderBy("created_at", "desc"));
                    onSnapshot(q, (snap) => {
                        history.value = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                });

                return { activeTab, form, previewText, saveAndCopy, loading, toast, toastMsg, history };
            }
        }).mount('#app');
    </script>
</body>
</html>