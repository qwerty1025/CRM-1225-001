<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÁæäÂ•∂ CRM (v3.7.0 Smart Layout)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            background-color: #f5f5f4; 
            color: #44403c;
            height: 100vh;
            overflow: hidden;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 99px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: #a8a29e; }

        .btn-press:active { transform: scale(0.97); filter: brightness(0.95); }
        
        /* v3.7.0 ÁúãÊùøÊ¨Ñ‰ΩçÂü∫Á§éÊ®£Âºè (ÂãïÊÖãÂØ¨Â∫¶Áî± Vue ÊéßÂà∂) */
        .kanban-col-base {
            @apply flex-shrink-0 flex flex-col bg-stone-200/60 rounded-xl overflow-hidden border border-stone-200 max-h-full transition-all duration-300;
        }
        .kanban-col-base:hover { @apply bg-stone-200/80 border-stone-300; }

        /* Ëº∏ÂÖ•Ê°ÜÂæÆÂûãÂåñ v3.7.0 */
        .input-sidebar { 
            @apply w-full bg-white border border-stone-300 rounded px-2 py-1 text-xs font-bold text-stone-700 outline-none focus:bg-white focus:border-stone-800 focus:ring-1 focus:ring-stone-800 transition shadow-sm;
            height: 28px;
        }
        .label-sidebar { @apply text-[9px] text-stone-400 font-bold mb-1 block uppercase tracking-wider ml-0.5; }

        .input-micro { 
            @apply w-full bg-stone-50 border border-stone-300 rounded px-1.5 py-0.5 text-[10px] font-bold text-stone-700 outline-none focus:border-emerald-500 focus:bg-white transition; 
            height: 24px;
        }

        /* È°ûÂûãÁáàËôü */
        .dot-type { @apply w-2 h-2 rounded-full shadow-sm ring-1 ring-white; }
        .dot-morning { @apply bg-orange-400; }
        .dot-family { @apply bg-rose-400; }
        .dot-group { @apply bg-violet-400; }

        /* UI Selectors (Type/Status) v3.7.0 */
        .ui-selector-btn {
            @apply flex items-center justify-center gap-1.5 px-2 py-1.5 rounded-md border text-[10px] font-bold transition cursor-pointer select-none;
        }
        
        /* Type Selector Styles */
        .type-btn-morning { @apply border-stone-200 text-stone-500 bg-white hover:bg-orange-50; }
        .type-btn-morning.active { @apply border-orange-400 bg-orange-100 text-orange-700 ring-1 ring-orange-400; }
        
        .type-btn-family { @apply border-stone-200 text-stone-500 bg-white hover:bg-rose-50; }
        .type-btn-family.active { @apply border-rose-400 bg-rose-100 text-rose-700 ring-1 ring-rose-400; }
        
        .type-btn-group { @apply border-stone-200 text-stone-500 bg-white hover:bg-violet-50; }
        .type-btn-group.active { @apply border-violet-400 bg-violet-100 text-violet-700 ring-1 ring-violet-400; }

        /* Status Selector Styles */
        .status-btn-base { @apply border-stone-200 bg-white text-stone-400 hover:border-stone-400; }
        .status-btn-base.active { @apply text-white shadow-md border-transparent transform scale-105; }
        
        /* Specific Status Active Colors */
        .status-btn-save.active { @apply bg-stone-500; }
        .status-btn-notified.active { @apply bg-amber-500; }
        .status-btn-billed.active { @apply bg-blue-500; }
        .status-btn-paid.active { @apply bg-emerald-500; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(231, 229, 228, 1);
        }

        .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); opacity: 0; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease-out; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Card Quick Status Buttons */
        .card-status-btn {
            @apply h-5 flex items-center justify-center text-[8px] font-bold border-t border-r border-stone-100 last:border-r-0 bg-stone-50 text-stone-400 hover:bg-stone-100 transition cursor-pointer;
        }
        .card-status-btn.active-btn { @apply text-white shadow-inner; }
        .bg-active-Êö´Â≠ò { @apply bg-stone-400; }
        .bg-active-Â∑≤ÈÄöÁü• { @apply bg-amber-400; }
        .bg-active-Â∑≤Âá∫Â∏≥ { @apply bg-blue-400; }
        .bg-active-Â∑≤Êî∂Ê¨æ { @apply bg-emerald-400; }

    </style>
</head>
<body class="h-screen w-screen flex flex-col text-slate-800 bg-stone-100">

    <div id="app" class="flex flex-col h-full w-full relative">

        <header class="glass-panel px-4 py-2 flex justify-between items-center shrink-0 z-50 h-[56px] shadow-sm">
            <div @click="reloadPage" class="font-bold text-base text-stone-800 flex items-center gap-2 cursor-pointer select-none btn-press group">
                <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-700 group-hover:bg-emerald-200 transition"><i class="fas fa-leaf"></i></div>
                <div class="flex flex-col leading-none">
                    <span class="tracking-tight text-lg font-extrabold text-stone-700">‰∫îÂØÆÂ∞ñ</span>
                    <span class="text-[9px] text-stone-400 font-mono">v3.7.0</span>
                </div>
            </div>
            
            <div v-if="currentTab === 'list'" class="hidden md:flex bg-stone-200 p-1 rounded-lg gap-1">
                <button v-for="mode in groupModes" :key="mode.key" 
                    @click="groupByField = mode.key"
                    :class="['px-3 py-1 rounded text-[10px] font-bold transition flex items-center gap-1.5', groupByField === mode.key ? 'bg-white text-stone-800 shadow-sm' : 'text-stone-500 hover:text-stone-700']">
                    <i :class="mode.icon"></i> {{ mode.label }}
                </button>
            </div>

            <div class="flex gap-2 items-center">
                <button @click="settingsModal.show = true" class="w-8 h-8 rounded-full hover:bg-stone-200 text-stone-600 transition flex items-center justify-center" title="Ë®≠ÂÆö"><i class="fas fa-cog"></i></button>

                <div v-if="currentTab === 'list'" class="flex bg-stone-200 rounded-lg p-0.5 ml-1">
                    <button @click="triggerImport" class="w-8 h-8 rounded-md hover:bg-white text-stone-600 text-xs transition shadow-sm"><i class="fas fa-file-import"></i></button>
                    <button @click="exportData" class="w-8 h-8 rounded-md hover:bg-white text-stone-600 text-xs transition shadow-sm"><i class="fas fa-file-export"></i></button>
                    <input type="file" ref="fileInput" class="hidden" @change="handleImport" accept=".json">
                </div>

                <button v-if="currentTab === 'create'" @click="saveOrder" :disabled="isSaving" class="btn-press bg-emerald-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-emerald-700 transition flex items-center gap-2 disabled:opacity-50">
                    <i class="fas fa-save"></i> ÂÑ≤Â≠ò
                </button>

                <button v-if="currentTab === 'list'" @click="switchToCreate" class="btn-press bg-emerald-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow hover:bg-emerald-700 transition">
                    <i class="fas fa-plus"></i>
                </button>
                <button v-if="currentTab === 'create'" @click="switchTab('list')" class="btn-press bg-white border border-stone-300 text-stone-600 w-9 h-9 rounded-lg flex items-center justify-center hover:bg-stone-100 transition shadow-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative flex flex-col bg-stone-100">

            <div v-if="currentTab === 'list'" class="flex-1 overflow-hidden flex flex-col">
                <div class="px-4 py-2 bg-white border-b border-stone-200 flex flex-wrap gap-3 items-center shrink-0 shadow-sm z-10">
                    
                    <div class="relative group w-48">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fas fa-search text-stone-300 text-xs group-focus-within:text-emerald-500 transition"></i>
                        </div>
                        <input type="text" v-model="searchQuery" placeholder="ÊêúÂ∞ã ÂßìÂêç / Âú∞ÂçÄ..." 
                            class="w-full pl-8 pr-3 py-1.5 bg-stone-100 border border-stone-200 rounded-full text-xs font-bold text-stone-700 outline-none focus:bg-white focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition placeholder-stone-400">
                    </div>

                    <div class="h-5 w-px bg-stone-200 mx-1"></div>

                    <label v-for="st in statusOptions" :key="st" class="cursor-pointer relative group select-none">
                        <input type="checkbox" :value="st" v-model="filterStatus" class="hidden peer">
                        <span class="px-3 py-1.5 rounded-lg border border-stone-200 text-[10px] font-extrabold text-stone-400 bg-white transition hover:border-stone-300 flex items-center gap-1.5
                                     peer-checked:bg-stone-800 peer-checked:text-white peer-checked:border-stone-800 peer-checked:shadow-sm">
                            <span :class="['w-1.5 h-1.5 rounded-full', filterStatus.includes(st) ? 'bg-white' : 'bg-stone-300']"></span>
                            {{ st }}
                        </span>
                    </label>

                    <div class="ml-auto text-[10px] text-stone-400 font-mono">
                        {{ filteredOrders.length }} cards
                    </div>
                </div>

                <div v-if="loading" class="flex-1 flex items-center justify-center text-stone-400 text-sm gap-2">
                    <i class="fas fa-circle-notch animate-spin text-emerald-500"></i> ËÆÄÂèñË≥áÊñôÂ∫´...
                </div>
                
                <div v-else class="flex-1 overflow-x-auto overflow-y-hidden custom-scroll p-4 bg-stone-100">
                    <div class="h-full flex gap-3 min-w-max pb-2">
                        
                        <div v-for="(group, groupKey) in groupedOrders" :key="groupKey" 
                             :class="['kanban-col-base', getSmartColumnWidth(group.length)]">
                            
                            <div class="px-3 py-2 border-b border-stone-300/50 flex justify-between items-center bg-stone-200/50 sticky top-0 z-10 backdrop-blur-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-2.5 h-2.5 rounded-full shadow-sm" :class="getGroupColor(groupKey)"></div>
                                    <span class="font-extrabold text-stone-700 text-xs truncate max-w-[120px]" :title="groupKey">{{ groupKey === 'undefined' ? 'Êú™ÂàÜÈ°û' : groupKey }}</span>
                                </div>
                                <span class="bg-white/80 text-stone-500 px-1.5 rounded text-[9px] font-bold shadow-sm">{{ group.length }}</span>
                            </div>

                            <div class="overflow-y-auto custom-scroll flex-1 p-2">
                                <div :class="['grid gap-2', getSmartGridCols(group.length)]">
                                    <div v-for="order in group" :key="order.id" class="bg-white rounded-lg shadow-sm border border-stone-200 hover:border-emerald-400 transition group relative cursor-pointer overflow-hidden flex flex-col h-min" @click="editOrder(order)">
                                        
                                        <div class="p-2.5 flex-1 relative">
                                            <div class="flex justify-between items-start mb-1.5">
                                                <div class="flex items-center gap-1.5 overflow-hidden">
                                                    <div :class="['dot-type flex-shrink-0', getTypeDotClass(order.type)]"></div>
                                                    <h3 class="font-extrabold text-stone-800 text-sm leading-none truncate">{{ order.customerName }}</h3>
                                                </div>
                                                <span class="text-emerald-700 font-extrabold font-mono text-xs">${{ (order.totalAmount || 0).toLocaleString() }}</span>
                                            </div>

                                            <div class="flex justify-between items-center mt-2">
                                                <div class="text-[9px] text-stone-400 font-bold bg-stone-50 px-1.5 py-0.5 rounded border border-stone-100 truncate flex items-center">
                                                    <i class="far fa-calendar-alt mr-1 text-[8px]"></i>{{ formatDateRangeShort(order.dates) }}
                                                </div>
                                                <span class="text-[9px] text-stone-500 font-bold bg-stone-100 px-1.5 rounded-full truncate max-w-[35%]">{{ order.area || '-' }}</span>
                                            </div>

                                            <button @click.stop="openHistory(order.customerName)" class="absolute top-8 right-2 opacity-0 group-hover:opacity-100 transition text-stone-300 hover:text-stone-500">
                                                <i class="fas fa-history text-xs"></i>
                                            </button>
                                        </div>

                                        <div class="grid grid-cols-4 border-t border-stone-100 bg-stone-50/50" @click.stop>
                                            <div v-for="st in statusOptions" :key="st" 
                                                 @click.stop="quickUpdateStatus(order, st)"
                                                 :class="['card-status-btn', order.status === st ? 'active-btn bg-active-' + st : '']"
                                                 :title="st">
                                                {{ st.substring(0,2) }}
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'create'" class="flex-1 flex flex-col lg:flex-row overflow-hidden bg-stone-50 relative">
                
                <button @click="isSidebarOpen = !isSidebarOpen" 
                    class="absolute top-2 left-2 z-30 w-6 h-6 bg-white border border-stone-300 rounded-md flex items-center justify-center text-stone-500 shadow-sm hover:bg-stone-50 transition lg:hidden">
                    <i :class="isSidebarOpen ? 'fas fa-chevron-left' : 'fas fa-chevron-right'"></i>
                </button>

                <div :class="['bg-white border-r border-stone-200 h-full flex flex-col z-20 shadow-xl overflow-hidden transition-all duration-300 ease-in-out absolute lg:relative', isSidebarOpen ? 'w-[300px] translate-x-0' : 'w-0 -translate-x-full lg:w-[300px] lg:translate-x-0 opacity-0 lg:opacity-100']">
                    
                    <div class="p-3 border-b border-stone-100 bg-stone-50/50 flex justify-between items-center shrink-0">
                        <span class="text-[10px] font-bold text-stone-400 uppercase tracking-widest"><i class="fas fa-user-edit mr-1"></i>Âü∫Êú¨Ë≥áÊñô</span>
                        <button @click="isSidebarOpen = false" class="lg:hidden text-stone-400"><i class="fas fa-times"></i></button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-5 min-w-[300px]">
                        
                        <div class="space-y-1">
                            <label class="label-sidebar">È°ßÂÆ¢ÂßìÂêç</label>
                            <div class="relative">
                                <input type="text" v-model="form.customerName" @input="onNameInput" list="customer-list" class="w-full bg-stone-50 border border-stone-300 rounded-lg px-3 py-2 text-sm font-extrabold focus:border-emerald-500 outline-none text-stone-800 transition shadow-inner" placeholder="Ëº∏ÂÖ•ÂßìÂêç...">
                            </div>
                            <datalist id="customer-list"><option v-for="c in savedCustomers" :value="c.name"></option></datalist>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="label-sidebar">Âú∞ÂçÄ (Area)</label>
                                <input type="text" v-model="form.area" list="area-options" class="input-sidebar">
                                <datalist id="area-options"><option v-for="a in uniqueAreas" :value="a"></option></datalist>
                            </div>
                            <div>
                                <label class="label-sidebar">ÂñÆÂÉπ (Price)</label>
                                <input type="number" v-model.number="form.unitPrice" class="input-sidebar text-right text-emerald-800 font-mono">
                            </div>
                        </div>

                        <div>
                            <label class="label-sidebar">È°ûÂûã (Type)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div @click="form.type = 'Êô®Èñì'" :class="['ui-selector-btn type-btn-morning', form.type === 'Êô®Èñì' ? 'active' : '']">
                                    <div class="dot-type dot-morning"></div>Êô®Èñì
                                </div>
                                <div @click="form.type = 'ÂÆ∂Â∫≠Ëôü'" :class="['ui-selector-btn type-btn-family', form.type === 'ÂÆ∂Â∫≠Ëôü' ? 'active' : '']">
                                    <div class="dot-type dot-family"></div>ÂÆ∂Â∫≠Ëôü
                                </div>
                                <div @click="form.type = 'ÂúòË≥º'" :class="['ui-selector-btn type-btn-group', form.type === 'ÂúòË≥º' ? 'active' : '']">
                                    <div class="dot-type dot-group"></div>ÂúòË≥º
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="label-sidebar">ÁãÄÊÖã (Status)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div v-for="s in statusOptions" :key="s" 
                                     @click="form.status = s"
                                     :class="['ui-selector-btn status-btn-base', 
                                              form.status === s ? getStatusBtnClass(s) + ' active' : '']">
                                    {{ s }}
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-stone-100">
                            <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg border border-transparent hover:bg-stone-50 hover:border-stone-200 transition group">
                                <input type="checkbox" v-model="form.ignoreHolidays" class="text-emerald-600 rounded focus:ring-0 w-3.5 h-3.5 border-stone-300">
                                <div>
                                    <span class="block text-[10px] font-bold text-stone-600 group-hover:text-stone-800">Âº∑Âà∂ÈÖçÈÄÅ (Ignore Holiday)</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col h-full overflow-hidden w-full lg:w-auto">
                    <div class="bg-white border-b border-stone-200 p-2 flex flex-wrap gap-2 justify-between items-center shadow-sm z-10 pl-10 lg:pl-2">
                        <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                            <button @click="setDays('weekday')" class="px-2 py-1 bg-stone-100 hover:bg-stone-200 rounded text-[10px] font-bold text-stone-600 transition whitespace-nowrap">Âπ≥Êó•</button>
                            <button @click="setDays('everyday')" class="px-2 py-1 bg-stone-100 hover:bg-stone-200 rounded text-[10px] font-bold text-stone-600 transition whitespace-nowrap">ÂÖ®Â§©</button>
                            <div class="h-4 w-px bg-stone-300 mx-1"></div>
                            <label v-for="d in [1,2,3,4,5,6,0]" :key="d" :class="['w-6 h-6 shrink-0 rounded flex items-center justify-center text-[10px] font-bold cursor-pointer transition select-none border', form.selectedDays.includes(d) ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white text-stone-300 border-stone-200 hover:border-stone-300']">
                                <input type="checkbox" :value="d" v-model="form.selectedDays" class="hidden" @change="generateDates">
                                {{ dayMap[d] }}
                            </label>
                        </div>
                        <div class="flex items-center gap-1 ml-auto">
                            <input type="month" v-model="dateRange.start" @change="generateDates" class="input-micro w-24 text-center">
                            <i class="fas fa-arrow-right text-stone-300 text-xs"></i>
                            <input type="month" v-model="dateRange.end" @change="generateDates" class="input-micro w-24 text-center">
                        </div>
                    </div>

                    <div class="flex flex-1 overflow-hidden">
                        <div class="flex-1 overflow-y-auto custom-scroll p-4 bg-stone-100/50">
                            <div class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-4">
                                <div v-for="(monthData, mIndex) in monthsGrid" :key="mIndex" class="bg-white border border-stone-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition">
                                    <div class="bg-stone-50 px-3 py-2 border-b border-stone-100 flex justify-between items-center cursor-pointer hover:bg-stone-100" @click="toggleMonth(monthData.days)">
                                        <span class="font-bold text-stone-700 font-mono text-sm">{{ monthData.title }}</span>
                                        <span v-if="monthData.total > 0" class="text-[9px] bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded-full font-bold shadow-sm">{{ monthData.total }}</span>
                                    </div>
                                    <div class="p-2">
                                        <div class="grid grid-cols-7 mb-1 text-center">
                                            <span class="text-[9px] text-stone-400 font-bold" v-for="w in ['‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠','Êó•']" :key="w">{{w}}</span>
                                        </div>
                                        <div class="grid grid-cols-7 gap-1">
                                            <div v-for="n in monthData.startDay" :key="'pad-'+n"></div>
                                            <div v-for="d in monthData.days" :key="d.fullDate" 
                                                @click="d.isValid ? toggleDateQty(d) : null" 
                                                :class="['aspect-square rounded-md flex flex-col items-center justify-center relative transition-all duration-75 border',
                                                    d.isValid 
                                                        ? (d.qty > 0 ? 'bg-emerald-500 border-emerald-600 shadow-sm cursor-pointer z-10 scale-105' : 'bg-white border-stone-100 cursor-pointer hover:border-emerald-300 hover:bg-emerald-50')
                                                        : 'bg-stone-100/30 border-transparent opacity-30 cursor-default'
                                                ]">
                                                <div v-if="d.isSpecial" class="absolute top-0.5 right-0.5 w-1.5 h-1.5 bg-purple-400 rounded-full z-20"></div>
                                                <span :class="['text-[10px] font-bold leading-none', d.qty > 0 ? 'text-white' : 'text-stone-600']">{{ d.dateStr }}</span>
                                                <div v-if="d.qty > 0" class="absolute -bottom-1 -right-1 w-3.5 h-3.5 bg-white text-emerald-700 rounded-full flex items-center justify-center text-[8px] font-extrabold shadow border border-emerald-100">{{ d.qty }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="w-[260px] bg-white border-l border-stone-200 flex flex-col shadow-lg z-20 hidden md:flex">
                            <div class="p-2 bg-emerald-50 border-b border-emerald-100 flex justify-between items-center">
                                <span class="text-[10px] font-bold text-emerald-800 uppercase">Bill</span>
                                <div class="flex bg-white rounded p-0.5 shadow-sm">
                                    <button @click="copyMode='A'" :class="['text-[9px] px-2 rounded transition', copyMode==='A'?'bg-emerald-600 text-white font-bold':'text-stone-400']">ÊòéÁ¥∞</button>
                                    <button @click="copyMode='B'" :class="['text-[9px] px-2 rounded transition', copyMode==='B'?'bg-emerald-600 text-white font-bold':'text-stone-400']">ÊúàÁµê</button>
                                </div>
                            </div>
                            <div class="flex-1 relative">
                                <textarea readonly v-model="generatedBillText" class="w-full h-full text-[10px] font-mono bg-white p-3 text-stone-700 outline-none resize-none leading-relaxed border-none"></textarea>
                                <button @click="copyBill" class="absolute bottom-4 right-4 bg-emerald-600 text-white w-8 h-8 rounded-full shadow-lg hover:bg-emerald-700 flex items-center justify-center transition transform active:scale-90" title="Ë§áË£ΩÂ∏≥ÂñÆ">
                                    <i class="far fa-copy text-xs"></i>
                                </button>
                            </div>
                            <div class="p-3 bg-stone-50 border-t border-stone-200">
                                <div class="flex justify-between items-end">
                                    <span class="text-xs text-stone-500 font-bold">Total</span>
                                    <span class="text-lg font-extrabold text-emerald-700 font-mono">${{ totalAmount.toLocaleString() }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <transition name="fade">
            <div v-if="historyModal.show" class="fixed inset-0 z-[60] flex items-center justify-center bg-stone-900/50 backdrop-blur-sm p-4 md:p-10" @click.self="historyModal.show = false">
                <div class="bg-white w-full max-w-5xl h-full max-h-[85vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row border border-white/60">
                    <div class="w-full md:w-1/2 bg-stone-50 flex flex-col border-r border-stone-200">
                        <div class="p-4 border-b border-stone-200 flex justify-between items-center bg-white">
                            <div><h3 class="font-bold text-lg text-stone-800">{{ historyModal.customerName }} <span class="text-xs text-stone-400 font-normal">Ê≠∑Âè≤Á¥ÄÈåÑ</span></h3></div>
                            <button @click="historyModal.show = false" class="w-8 h-8 rounded-full bg-stone-100 text-stone-500 hover:bg-stone-200 flex items-center justify-center"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3">
                            <div v-for="ord in historyModal.orders" :key="ord.id" 
                                :class="['bg-white border rounded-xl p-3 cursor-pointer transition flex items-center gap-3 relative overflow-hidden', historyModal.selectedIds.includes(ord.id) ? 'border-emerald-500 ring-1 ring-emerald-500 shadow-md' : 'border-stone-200 hover:border-emerald-300']"
                                @click="toggleHistorySelection(ord)">
                                <div :class="['w-1 h-full absolute left-0 top-0', getStatusColorBg(ord.status)]"></div>
                                <div class="flex items-center justify-center w-5 h-5 rounded border border-stone-300 text-white" :class="historyModal.selectedIds.includes(ord.id) ? 'bg-emerald-500 border-emerald-500' : 'bg-white'"><i class="fas fa-check text-[10px]" v-show="historyModal.selectedIds.includes(ord.id)"></i></div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[10px] bg-stone-100 text-stone-500 px-1.5 rounded font-bold">{{ formatDateRangeShort(ord.dates) }}</span>
                                        <span class="text-emerald-700 font-bold font-mono text-sm">${{ ord.totalAmount }}</span>
                                    </div>
                                    <div class="flex justify-between items-end">
                                        <span class="text-[10px] text-stone-400">{{ ord.totalCount }} Áì∂ @ {{ ord.unitPrice }}</span>
                                        <span class="text-[9px] px-1.5 py-0.5 rounded border text-stone-500 bg-stone-50">{{ ord.status }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 bg-white flex flex-col relative">
                        <div class="p-3 border-b border-stone-100 flex justify-between items-center">
                            <span class="font-bold text-stone-700 text-sm">Âêà‰ΩµÈ†êË¶Ω</span>
                            <button v-if="historyModal.selectedIds.length > 0" @click="copyCombinedBill" class="bg-emerald-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-emerald-700 transition"><i class="far fa-copy mr-1"></i>Ë§áË£Ω</button>
                        </div>
                        <textarea readonly :value="combinedBillText" class="flex-1 w-full p-6 text-xs font-mono text-stone-700 outline-none resize-none leading-relaxed"></textarea>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="settingsModal.show" class="fixed inset-0 z-[70] flex items-center justify-center bg-stone-900/60 backdrop-blur-sm p-6" @click.self="settingsModal.show = false">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col h-[70vh] border border-white/50">
                    <div class="p-4 border-b border-stone-200 bg-stone-50 flex justify-between items-center">
                        <h3 class="font-bold text-stone-800 text-sm">ÁáüÈÅãË®≠ÂÆö</h3>
                        <button @click="settingsModal.show = false" class="text-stone-400 hover:text-stone-600"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto custom-scroll space-y-3">
                        <div class="flex gap-2">
                            <input type="date" v-model="newHoliday.date" class="w-full bg-white border border-stone-300 rounded px-2 py-1 text-xs outline-none">
                            <input type="text" v-model="newHoliday.reason" placeholder="ÂéüÂõ†" class="w-full bg-white border border-stone-300 rounded px-2 py-1 text-xs outline-none">
                            <button @click="addHoliday" class="bg-emerald-600 text-white rounded px-3 text-xs font-bold shadow hover:bg-emerald-700"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="space-y-2 mt-4">
                             <div v-for="(reason, date) in specialDays" :key="date" class="flex justify-between items-center bg-stone-50 p-2 rounded border border-stone-200">
                                <div><div class="text-[11px] font-bold text-stone-700">{{ date }}</div><div class="text-[10px] text-purple-600 font-bold">{{ reason }}</div></div>
                                <button @click="removeHoliday(date)" class="text-stone-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="modal.show" class="fixed inset-0 z-[80] flex items-center justify-center bg-stone-900/40 backdrop-blur-sm p-6" @click.self="closeModal">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center border border-white/50">
                    <div :class="['w-10 h-10 rounded-full flex items-center justify-center mx-auto mb-3 text-lg shadow-sm', modal.type==='error'?'bg-red-50 text-red-500':'bg-emerald-50 text-emerald-500']">
                        <i :class="modal.type==='error'?'fas fa-exclamation':'fas fa-check'"></i>
                    </div>
                    <h3 class="font-bold text-base mb-1 text-stone-800">{{ modal.title }}</h3>
                    <p class="text-xs text-stone-600 mb-5 break-all leading-relaxed">{{ modal.message }}</p>
                    <button @click="closeModal" class="w-full bg-stone-800 text-white py-2 rounded-xl font-bold hover:bg-stone-900 transition text-xs shadow-lg">Á¢∫ÂÆö</button>
                </div>
            </div>
        </transition>

    </div>

    <script type="module">
        import { createApp, ref, computed, reactive, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref as dbRef, push, onValue, remove, update, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        createApp({
            setup() {
                const currentTab = ref('list');
                const loading = ref(true);
                const isSaving = ref(false);
                const editMode = ref(false);
                const currentOrderId = ref(null);
                const searchQuery = ref('');
                const isSidebarOpen = ref(true);

                const modal = reactive({ show: false, title: '', message: '', type: 'info' });
                const settingsModal = reactive({ show: false });
                const historyModal = reactive({ show: false, customerName: '', orders: [], selectedIds: [] });

                const orders = ref([]);
                const savedCustomers = ref([]);
                const specialDays = ref({});
                const newHoliday = reactive({ date: '', reason: '' });
                const fileInput = ref(null);

                const statusOptions = ['Êö´Â≠ò', 'Â∑≤ÈÄöÁü•', 'Â∑≤Âá∫Â∏≥', 'Â∑≤Êî∂Ê¨æ'];
                const filterStatus = ref([...statusOptions]);
                const groupByField = ref('status');
                const groupModes = [
                    { key: 'status', label: 'ÁãÄÊÖã', icon: 'fas fa-tasks' },
                    { key: 'area', label: 'Âú∞ÂçÄ', icon: 'fas fa-map-marked-alt' },
                    { key: 'type', label: 'È°ûÂûã', icon: 'fas fa-tags' }
                ];

                const dateRange = reactive({ start: '2025-06', end: '2026-03' });
                const form = reactive({ 
                    customerName: '', area: '', unitPrice: 30, 
                    status: 'Êö´Â≠ò', type: 'Êô®Èñì', selectedDays: [1],
                    ignoreHolidays: false 
                });
                const quantityMap = reactive(new Map());
                const dayMap = { 1: '‰∏Ä', 2: '‰∫å', 3: '‰∏â', 4: 'Âõõ', 5: '‰∫î', 6: 'ÂÖ≠', 0: 'Êó•' };
                const copyMode = ref('A');

                const showModal = (t, m, type='success') => { modal.title = t; modal.message = m; modal.type = type; modal.show = true; };
                const closeModal = () => modal.show = false;
                const reloadPage = () => window.location.reload();

                const exportData = () => {
                    const dataStr = JSON.stringify(orders.value, null, 2);
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `crm_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
                };
                const triggerImport = () => fileInput.value.click();
                const handleImport = (e) => {
                    const file = e.target.files[0]; if(!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if(Array.isArray(data) && confirm(`Á¢∫Ë™çÂåØÂÖ• ${data.length} Á≠ÜË≥áÊñôÔºü`)) {
                                for(const item of data) { const { id, ...c } = item; await push(dbRef(db, 'orders'), c); }
                                showModal('ÂåØÂÖ•ÊàêÂäü', `ÊàêÂäüËºâÂÖ• ${data.length} Á≠Ü`);
                            }
                        } catch(err) { showModal('ÂåØÂÖ•Â§±Êïó', err.message, 'error'); }
                    };
                    reader.readAsText(file);
                };

                onMounted(() => {
                    onValue(dbRef(db, 'orders'), (s) => { 
                        const d = s.val(); 
                        orders.value = d ? Object.entries(d).map(([k, v]) => ({ id: k, ...v })) : []; 
                        loading.value = false; 
                    });
                    onValue(dbRef(db, 'customers'), (s) => { savedCustomers.value = s.val() ? Object.values(s.val()) : []; });
                    onValue(dbRef(db, 'settings/holidays'), (s) => { specialDays.value = s.val() || {}; });
                });

                const filteredOrders = computed(() => {
                    return orders.value.filter(o => {
                        const statusMatch = filterStatus.value.includes(o.status || 'Êö´Â≠ò');
                        const searchLower = searchQuery.value.toLowerCase();
                        const searchMatch = !searchQuery.value || 
                                            (o.customerName && o.customerName.toLowerCase().includes(searchLower)) ||
                                            (o.area && o.area.toLowerCase().includes(searchLower));
                        return statusMatch && searchMatch;
                    }).sort((a,b) => new Date(b.updatedAt||b.createdAt||0) - new Date(a.updatedAt||a.createdAt||0));
                });

                const groupedOrders = computed(() => {
                    const groups = {};
                    const field = groupByField.value;
                    filteredOrders.value.forEach(order => {
                        let key = order[field];
                        if (field === 'status' && !key) key = 'Êö´Â≠ò';
                        if (field === 'area' && !key) key = 'Êú™ÂàÜÂçÄ';
                        if (field === 'type' && !key) key = 'Êú™ÂàÜÈ°û';
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(order);
                    });
                    const sortedKeys = Object.keys(groups).sort((a,b) => {
                         if(field === 'status') return statusOptions.indexOf(a) - statusOptions.indexOf(b);
                         return a.localeCompare(b);
                    });
                    const sortedGroups = {};
                    sortedKeys.forEach(k => sortedGroups[k] = groups[k]);
                    return sortedGroups;
                });

                // v3.7.0 Smart Grid Logic
                const getSmartColumnWidth = (count) => {
                    if (count > 16) return 'w-[50rem]'; // 3 cols
                    if (count > 8) return 'w-[33rem]'; // 2 cols
                    return 'w-64'; // 1 col
                };
                const getSmartGridCols = (count) => {
                    if (count > 16) return 'grid-cols-3';
                    if (count > 8) return 'grid-cols-2';
                    return 'grid-cols-1';
                };

                const openHistory = (name) => {
                    if(!name) return;
                    historyModal.customerName = name;
                    historyModal.orders = orders.value.filter(o => o.customerName === name).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                    historyModal.selectedIds = [];
                    historyModal.show = true;
                };
                const toggleHistorySelection = (ord) => {
                    const idx = historyModal.selectedIds.indexOf(ord.id);
                    if(idx > -1) historyModal.selectedIds.splice(idx, 1);
                    else historyModal.selectedIds.push(ord.id);
                };

                const combinedBillText = computed(() => {
                    if(historyModal.selectedIds.length === 0) return 'Ë´ãÂãæÈÅ∏Â∑¶ÂÅ¥Ë®ÇÂñÆ...';
                    const selected = historyModal.orders.filter(o => historyModal.selectedIds.includes(o.id));
                    let totalVal = 0, totalBtls = 0, details = '';
                    selected.forEach(o => {
                        totalVal += (parseInt(o.totalAmount) || 0);
                        totalBtls += (parseInt(o.totalCount) || 0);
                        details += `‚Ä¢ ${formatDateRangeShort(o.dates)}ÔΩú${o.totalCount}Áì∂ $${o.totalAmount}\n`;
                    });
                    return `È°ßÂÆ¢Ôºö${historyModal.customerName}\n------------------\n${details}------------------\nÂÖ±Ôºö${totalBtls} Áì∂\nÊáâÊî∂ÔºöNT$${totalVal.toLocaleString()}`;
                });
                const copyCombinedBill = () => { navigator.clipboard.writeText(combinedBillText.value).then(() => showModal('Â∑≤Ë§áË£Ω', 'Âêà‰ΩµÂ∏≥ÂñÆÂÖßÂÆπÂ∑≤Ë§áË£Ω')); };

                const toSafeKey = (d) => d.replace(/\//g, '-');
                
                const monthsGrid = computed(() => {
                    if (!dateRange.start || !dateRange.end) return [];
                    const [sy, sm] = dateRange.start.split('-').map(Number);
                    const [ey, em] = dateRange.end.split('-').map(Number);
                    const start = new Date(sy, sm - 1, 1);
                    const end = new Date(ey, em, 0);
                    const activeDays = new Set(form.selectedDays);
                    const grids = [];
                    let current = new Date(start);
                    while (current <= end) {
                        const y = current.getFullYear();
                        const m = current.getMonth();
                        const mStr = (m + 1).toString().padStart(2, '0');
                        const monthKey = `${y}-${mStr}`;
                        const daysInMonth = new Date(y, m + 1, 0).getDate();
                        const firstDayOfWeek = (new Date(y, m, 1).getDay() - 1 + 7) % 7;
                        const days = [];
                        let totalQty = 0;
                        for (let d = 1; d <= daysInMonth; d++) {
                            const dStr = d.toString().padStart(2, '0');
                            const fDate = `${y}/${mStr}/${dStr}`;
                            const fDateDash = `${y}-${mStr}-${dStr}`; 
                            const dayOfWeek = new Date(y, m, d).getDay();
                            const isValid = activeDays.has(dayOfWeek);
                            const specialReason = specialDays.value[fDateDash];
                            const isSpecial = !!specialReason;
                            let qty = quantityMap.get(fDate) || 0;
                            if (isValid) totalQty += qty;
                            days.push({ fullDate: fDate, dateStr: dStr, dayStr: dayOfWeek, qty: qty, isValid: isValid, isSpecial: isSpecial, specialReason: specialReason });
                        }
                        const amount = Math.floor(totalQty * form.unitPrice);
                        grids.push({ title: monthKey, days: days, startDay: firstDayOfWeek, total: totalQty, amount: amount.toLocaleString() });
                        current = new Date(y, m + 1, 1);
                    }
                    return grids;
                });

                const toggleDateQty = (d) => { 
                    let q = d.qty; 
                    if (q === 0) q = 1; else if (q === 1) q = 2; else if (q === 2) q = 1.5; else q = 0;
                    quantityMap.set(d.fullDate, q);
                };
                
                const toggleMonth = (days) => {
                    const validDays = days.filter(d => d.isValid);
                    if(validDays.length === 0) return;
                    const targets = form.ignoreHolidays ? validDays : validDays.filter(d => !d.isSpecial);
                    const hasQty = targets.some(d => quantityMap.get(d.fullDate) > 0);
                    targets.forEach(d => quantityMap.set(d.fullDate, hasQty ? 0 : 1));
                };

                const totalCount = computed(() => {
                    let sum = 0;
                    for (const q of quantityMap.values()) sum += q;
                    return sum;
                });
                const totalAmount = computed(() => Math.floor(totalCount.value * form.unitPrice));

                const generatedBillText = computed(() => {
                    const active = [];
                    const sortedKeys = Array.from(quantityMap.keys()).sort();
                    for(const k of sortedKeys) {
                        if(quantityMap.get(k) > 0) {
                            const [y,m,d] = k.split('/');
                            active.push({ fullDate: k, dateStr: d, qty: quantityMap.get(k) });
                        }
                    }
                    if (active.length === 0) return 'Â∞öÊú™ÈÅ∏ÊìáÊó•Êúü';
                    const header = active[0].fullDate.substring(0, 7).replace('/', '-');
                    const byMonth = {};
                    active.forEach(d => {
                        const k = d.fullDate.substring(0, 7);
                        if (!byMonth[k]) byMonth[k] = [];
                        byMonth[k].push(d);
                    });

                    let details = '';
                    if (copyMode.value === 'A') {
                        for(const [mKey, dates] of Object.entries(byMonth)) {
                            const [y, m] = mKey.split('/');
                            details += `\nüî∫ ${parseInt(m)}Êúà\n`;
                            details += dates.map(d => `${parseInt(d.dateStr)}${d.qty!==1?'*'+d.qty:''}`).join('„ÄÅ') + '\n';
                        }
                    } else {
                        details += '\nÈÖçÈÄÅÁµ±Ë®àÔºö\n';
                        for(const [mKey, dates] of Object.entries(byMonth)) {
                            const [y, m] = mKey.split('/');
                            const sum = dates.reduce((a,b)=>a+b.qty,0);
                            details += `${parseInt(m)}Êúà: ${sum}Áì∂\n`;
                        }
                    }
                    return `ÈÖçÈÄÅÂ∏≥ÂñÆ (${header})\nÈ°ßÂÆ¢Ôºö${form.customerName}\n${details}------------------\nÁ∏ΩË®àÔºö${totalCount.value} Áì∂\nÊáâÊî∂ÔºöNT$${totalAmount.value}`;
                });
                const copyBill = () => { navigator.clipboard.writeText(generatedBillText.value).then(() => showModal('Ë§áË£ΩÊàêÂäü', 'ÊòéÁ¥∞Â∑≤Ë§áË£Ω')); };

                const saveOrder = async () => {
                    if (!form.customerName) { showModal('ÈåØË™§', 'Ë´ãËº∏ÂÖ•ÂßìÂêç', 'error'); return; }
                    isSaving.value = true;
                    try {
                        const datesObj = {};
                        for (const [k, v] of quantityMap.entries()) { if(v > 0) datesObj[toSafeKey(k)] = v; }
                        const payload = {
                            customerName: form.customerName, area: form.area || 'Êú™ÂàÜÂçÄ', unitPrice: form.unitPrice || 30,
                            status: form.status || 'Êö´Â≠ò', type: form.type || 'Êô®Èñì', selectedDays: form.selectedDays || [],
                            totalAmount: totalAmount.value, totalCount: totalCount.value, dates: datesObj, 
                            updatedAt: new Date().toISOString(), ignoreHolidays: form.ignoreHolidays || false
                        };
                        if (editMode.value && currentOrderId.value) await update(dbRef(db, `orders/${currentOrderId.value}`), payload);
                        else { payload.createdAt = new Date().toISOString(); await push(dbRef(db, 'orders'), payload); }
                        
                        const key = btoa(encodeURIComponent(form.customerName)).replace(/[^a-zA-Z0-9]/g, '');
                        await update(dbRef(db, `customers/${key}`), { 
                            name: form.customerName, area: form.area, unitPrice: form.unitPrice,
                            type: form.type, status: form.status, ignoreHolidays: form.ignoreHolidays 
                        });
                        showModal('ÂÑ≤Â≠òÊàêÂäü', 'Ë®ÇÂñÆÂ∑≤Êõ¥Êñ∞');
                        switchTab('list');
                    } catch (e) { showModal('ÂÑ≤Â≠òÂ§±Êïó', e.message, 'error'); } 
                    finally { isSaving.value = false; }
                };

                const quickUpdateStatus = async (order, newStatus) => {
                    if (order.status === newStatus) return;
                    try {
                        await update(dbRef(db, `orders/${order.id}`), { status: newStatus, updatedAt: new Date().toISOString() });
                    } catch(e) { console.error(e); }
                };

                const editOrder = (o) => {
                    editMode.value = true; currentOrderId.value = o.id;
                    form.customerName = o.customerName || ''; form.area = o.area || ''; form.unitPrice = o.unitPrice || 30;
                    form.status = o.status || 'Êö´Â≠ò'; form.type = o.type || 'Êô®Èñì'; form.selectedDays = o.selectedDays || [1];
                    form.ignoreHolidays = o.ignoreHolidays || false;
                    quantityMap.clear();
                    if(o.dates) { for(const [k, v] of Object.entries(o.dates)) { quantityMap.set(k.replace(/-/g, '/'), v); } }
                    isSidebarOpen.value = true; 
                    switchTab('create');
                };

                const onNameInput = () => { 
                    const f = savedCustomers.value.find(c => c.name === form.customerName); 
                    if (f) { 
                        form.area = f.area || ''; form.unitPrice = f.unitPrice || 30;
                        if(f.type) form.type=f.type; if(f.status) form.status=f.status; 
                        form.ignoreHolidays = f.ignoreHolidays || false;
                    } 
                };

                const switchTab = (t) => {
                    if (t === 'create' && !editMode.value) { 
                        form.customerName=''; form.area=''; form.unitPrice=30; 
                        form.status='Êö´Â≠ò'; form.type='Êô®Èñì'; form.selectedDays=[1]; form.ignoreHolidays=false;
                        quantityMap.clear();
                        isSidebarOpen.value = true;
                    } 
                    else if (t === 'list') { editMode.value = false; currentOrderId.value = null; }
                    currentTab.value = t;
                };
                const switchToCreate = () => { editMode.value = false; switchTab('create'); };

                const setDays = (type) => {
                    if(type === 'weekday') form.selectedDays = [1,2,3,4,5];
                    else form.selectedDays = [0,1,2,3,4,5,6];
                };
                const addHoliday = () => {
                    if(newHoliday.date && newHoliday.reason) {
                        update(dbRef(db, 'settings/holidays'), { [newHoliday.date]: newHoliday.reason });
                        newHoliday.date = ''; newHoliday.reason = '';
                    }
                };
                const removeHoliday = (date) => { if(confirm('ÁßªÈô§Ê≠§ÂÅáÊó•Ôºü')) remove(dbRef(db, `settings/holidays/${date}`)); };
                
                const formatDateRangeShort = (dates) => {
                    if (!dates) return '';
                    const keys = Object.keys(dates).sort();
                    if (keys.length === 0) return '';
                    const start = keys[0].substring(5); 
                    const end = keys[keys.length - 1].substring(5);
                    return start === end ? start : `${start}~${end}`;
                };

                const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c => c.area).filter(Boolean))]);
                const getStatusColorBg = (s) => { 
                    switch(s){ case 'Â∑≤ÈÄöÁü•':return 'bg-amber-400'; case 'Â∑≤Âá∫Â∏≥':return 'bg-blue-400'; case 'Â∑≤Êî∂Ê¨æ':return 'bg-emerald-400'; default:return 'bg-stone-300'; }
                };
                const getStatusBtnClass = (s) => {
                    switch(s){ case 'Â∑≤ÈÄöÁü•':return 'status-btn-notified'; case 'Â∑≤Âá∫Â∏≥':return 'status-btn-billed'; case 'Â∑≤Êî∂Ê¨æ':return 'status-btn-paid'; default:return 'status-btn-save'; }
                };
                const getTypeDotClass = (t) => {
                    switch(t){ case 'ÂÆ∂Â∫≠Ëôü':return 'dot-family'; case 'ÂúòË≥º':return 'dot-group'; default:return 'dot-morning'; }
                };
                const getGroupColor = (k) => {
                    if(k==='Â∑≤Êî∂Ê¨æ') return 'bg-emerald-500'; if(k==='Â∑≤Âá∫Â∏≥') return 'bg-blue-500'; if(k==='Â∑≤ÈÄöÁü•') return 'bg-amber-500'; if(k==='Êö´Â≠ò') return 'bg-stone-400';
                    return 'bg-stone-400';
                };

                return {
                    currentTab, loading, isSaving, editMode, switchTab, switchToCreate,
                    form, savedCustomers, uniqueAreas, onNameInput, dayMap,
                    monthsGrid, toggleDateQty, modal, showModal, closeModal,
                    totalCount, totalAmount, generatedBillText, copyBill, 
                    settingsModal, newHoliday, addHoliday, removeHoliday, specialDays,
                    saveOrder, editOrder, formatDateRangeShort,
                    getStatusColorBg, getTypeDotClass, reloadPage, copyMode,
                    exportData, handleImport, triggerImport, fileInput,
                    statusOptions, filterStatus, filteredOrders, dateRange,
                    groupByField, groupModes, groupedOrders, getGroupColor,
                    historyModal, openHistory, toggleHistorySelection, combinedBillText, copyCombinedBill,
                    setDays, toggleMonth,
                    searchQuery, quickUpdateStatus, isSidebarOpen,
                    // v3.7.0 Smart Layout
                    getSmartColumnWidth, getSmartGridCols, getStatusBtnClass
                };
            }
        }).mount('#app');
    </script>
</body>
</html>