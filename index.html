<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶ä¸­æ§ç³»çµ± V15 (è¡—å€ç®¡ç†ç‰ˆ)</title>
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-collapsed: 50px;
            --primary: #2c3e50;
            --accent: #8e44ad; /* V15 æ”¹ç‚ºç´«è‰²ç³»å€åˆ† */
            --bg: #f0f2f5;
            --border: #e0e0e0;
            --group-bg: #f3e5f5; /* æ·ºç´«ç¾¤çµ„åº•è‰² */
        }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; overflow: hidden; }

        /* å·¦å´æ¬„ */
        .sidebar {
            width: var(--sidebar-width); background: white; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; transition: width 0.3s ease; flex-shrink: 0; z-index: 10;
        }
        .sidebar.collapsed { width: var(--sidebar-collapsed); }
        .sidebar.collapsed .sb-text, .sidebar.collapsed .search-box, .sidebar.collapsed .c-info, .sidebar.collapsed .btn-label, .sidebar.collapsed .addr-header { display: none; }
        .sidebar.collapsed .c-item { justify-content: center; padding: 10px; }
        .sidebar.collapsed .c-item span { display: none; }
        .sidebar.collapsed .c-item::after { content: "â—"; color: var(--accent); }
        
        .sb-header { padding: 10px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .toggle-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.1rem; }
        .search-box { padding: 8px; border-bottom: 1px solid #eee; background: #fff; }
        .search-box input { width: 100%; padding: 5px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8rem; }
        
        .c-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }

        /* V15 ç¾¤çµ„æ¨™é¡Œ (è¡—å€) */
        .addr-group { border-bottom: 1px solid #eee; }
        .addr-header {
            background: var(--group-bg);
            color: #4a148c;
            padding: 4px 10px;
            font-size: 0.75rem; /* text-xs */
            font-weight: bold;
            display: flex; align-items: center; gap: 5px;
            position: sticky; top: 0; z-index: 5;
            border-bottom: 1px solid #e1bee7;
        }

        /* åˆ—è¡¨é …ç›® */
        .c-item { 
            padding: 4px 10px 4px 20px;
            cursor: pointer; 
            display: flex; align-items: center; justify-content: space-between;
            min-height: 28px;
            transition: background 0.1s;
            background: white;
            font-size: 0.75rem; /* text-xs */
            color: #333;
            border-bottom: 1px dashed #f5f5f5;
        }
        .c-item:hover { background: #f3e5f5; }
        .c-item.active { background: #e1bee7; color: #000; font-weight: bold; border-left: 3px solid var(--accent); padding-left: 17px; }
        
        .c-item-content { display: flex; align-items: center; gap: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; width: 100%; }
        .c-name { font-weight: bold; color: #2c3e50; }
        .c-divider { color: #ccc; font-size: 0.7rem; }
        .c-phone { color: #888; font-family: monospace; }

        /* å´é‚Šæ¬„åº•éƒ¨ */
        .sb-footer { padding: 8px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 5px; background: #fff; }
        .sb-btn { 
            width: 100%; padding: 6px; border: none; font-weight: bold; cursor: pointer; 
            border-radius: 3px; text-align: left; display: flex; align-items: center; gap: 8px;
            font-size: 0.8rem;
        }
        .btn-add { background: #2c3e50; color: white; justify-content: center;}
        
        .io-group { display: flex; gap: 5px; }
        .btn-io { flex: 1; background: #ecf0f1; color: #555; font-size: 0.75rem; justify-content: center;}
        .btn-io:hover { background: #d0d3d4; }

        /* ä¸»å…§å®¹ */
        .main { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; position: relative; }
        
        /* V15 Header èª¿æ•´ï¼šé›™å±¤çµæ§‹ä»¥å®¹ç´æ›´å¤šè³‡è¨Š */
        .header-container { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 8px; }
        .header-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        input, select { padding: 5px 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9rem; }
        input:focus, select:focus { outline: 2px solid var(--accent); border-color: transparent; }
        
        /* V15 æ–°å¢æ¬„ä½æ¨£å¼ */
        .sector-select { background-color: #f3e5f5; color: #4a148c; font-weight: bold; border: 1px solid #e1bee7; }
        .note-input { font-size: 0.8rem; flex: 1; border-bottom: 1px solid #ddd; background: #fafafa; }
        .note-label { font-size: 0.75rem; color: #888; margin-right: 5px; font-weight: bold; }

        .btn-clone { background: #f39c12; color: white; border: none; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; margin-left: auto; }

        .empty-state { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999; }

        /* çŸ©é™£è¨­å®š */
        .config-card { background: white; border-radius: 6px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 8px; }
        .matrix-table th { background: #f8f9fa; padding: 6px; border: 1px solid #eee; color: #555; }
        .matrix-table td { border: 1px solid #eee; padding: 4px; text-align: center; }
        
        .t-btn { 
            display: inline-block; width: 24px; height: 24px; line-height: 24px; 
            border: 1px solid #eee; border-radius: 3px; cursor: pointer; margin: 0 1px; 
            color: #ccc; background: white; font-size: 0.8rem; user-select: none;
        }
        .t-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }

        .pt-row { display: flex; gap: 5px; flex-wrap: wrap; }
        .pt-btn { font-size: 0.75rem; padding: 3px 8px; background: #ede7f6; color: #4a148c; border-radius: 10px; cursor: pointer; border: 1px solid #d1c4e9; }

        /* æ—¥æ›† */
        .cal-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .cal-card { background: white; border-radius: 6px; padding: 8px; border-top: 3px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .cal-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.85rem; padding-bottom: 5px; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .cal-head { font-size: 0.75rem; text-align: center; color: #aaa; }
        .cal-cell { aspect-ratio: 1; border: 1px solid #f5f5f5; position: relative; cursor: pointer; border-radius: 3px; }
        .date-num { position: absolute; top: 2px; left: 2px; font-size: 0.65rem; color: #666; font-weight: bold; }
        .content-badge {
            position: absolute; bottom: 1px; right: 1px; left: 1px;
            background: rgba(255,255,255,0.9); border: 1px solid #ddd;
            border-radius: 2px; font-size: 0.65rem; text-align: center;
            color: #333; font-weight: bold; padding: 0;
        }
        
        .st-normal { background: #d1c4e9; } /* V15 ç´«è‰²ç³» */
        .st-paused { background: #ffcdd2; }
        .st-missed { background: #fff9c4; border: 1px solid #fbc02d; }
        .st-holiday { background: #f5f5f5; }
        .st-paused .content-badge { text-decoration: line-through; color: #c62828; opacity: 0.7; }

        /* æµ®å‹•æŒ‰éˆ• */
        .fab-group { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; align-items: end; }
        .fab-btn { 
            padding: 10px 18px; border-radius: 30px; border: none; color: white; 
            font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            display: flex; align-items: center; gap: 5px; transition: transform 0.1s; font-size: 0.9rem;
        }
        .fab-btn:active { transform: scale(0.95); }
        .btn-save { background: #8e44ad; }
        .btn-save-exit { background: #2c3e50; }

        /* åŒ¯å…¥é®ç½© */
        #importModal {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); 
            display:none; justify-content:center; align-items:center; z-index:100;
        }
        .modal-box { background:white; padding:20px; border-radius:8px; text-align:center; width:300px; }

    </style>
</head>
<body>

<nav class="sidebar" id="sidebar">
    <div class="sb-header">
        <span class="sb-text">ğŸŒ† V15 è¡—å€ç®¡ç†</span>
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
    </div>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€åœ°å€..." oninput="filterList()">
    </div>
    
    <div class="c-list" id="customerList">
        <div style="padding:15px; text-align:center; color:#999; font-size:0.75rem;">è¼‰å…¥ä¸­...</div>
    </div>
    
    <div class="sb-footer">
        <button class="sb-btn btn-add" onclick="resetForm(true)">
            <span>+ æ–°å¢å®¢æˆ¶</span>
        </button>
        <div class="io-group">
            <button class="sb-btn btn-io" onclick="document.getElementById('csvInput').click()">
                ğŸ“‚ åŒ¯å…¥
            </button>
            <button class="sb-btn btn-io" onclick="exportCSV()">
                ğŸ’¾ åŒ¯å‡º
            </button>
        </div>
        <input type="file" id="csvInput" accept=".csv" style="display:none">
    </div>
</nav>

<main class="main">
    <div id="emptyState" class="empty-state">
        <h2>ğŸ‘‹ V15 å°±ç·’</h2>
        <p>è¡—å€åˆ†çµ„æ¨¡å¼ (é è¨­ï¼šå…¶ä»–)</p>
        <p style="font-size:0.75rem; color:#bbb;">é¸æ“‡å·¦å´å®¢æˆ¶é€²è¡Œç·¨è¼¯</p>
    </div>

    <div id="workspace" style="display:none; flex-direction:column; gap:15px;">
        <div class="header-container">
            <div class="header-row">
                <select id="inpSector" class="sector-select" style="min-width: 80px;">
                    </select>
                <input type="text" id="inpName" placeholder="å®¢æˆ¶å§“å" style="font-size:1.1rem; font-weight:bold; width:90px; border:none; border-bottom:1px solid #ccc;">
                <input type="text" id="inpPhone" placeholder="é›»è©±" style="width:110px; border:1px solid #eee; padding:3px;">
                <input type="text" id="inpAddr" placeholder="è©³ç´°åœ°å€" style="flex:1; border:1px solid #eee; padding:3px; min-width: 120px;">
                <label style="font-size:0.85rem;">$ <input type="number" id="inpPrice" value="35" style="width:40px;"></label>
                <button class="btn-clone" onclick="cloneCustomer()">ğŸ“‘ è¤‡è£½</button>
            </div>
            <div class="header-row" style="background: #fdfdfd; padding: 5px; border-radius: 4px; border: 1px dotted #eee;">
                <span class="note-label">å‚™è¨»A:</span>
                <input type="text" id="inpNoteA" class="note-input" placeholder="ç©ºç™½">
                <span class="note-label" style="margin-left: 10px;">å‚™è¨»B:</span>
                <input type="text" id="inpNoteB" class="note-input" placeholder="ç©ºç™½">
            </div>
        </div>

        <div class="config-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div class="pt-row" id="patternBox"></div>
                <label style="font-size:0.85rem;"><input type="checkbox" id="chkHoliday"> è¦‹ç´…ä¸ä¼‘</label>
            </div>
            <table class="matrix-table">
                <thead>
                    <tr><th style="width:40px;"></th><th>åŸå‘³ (1,2,4,6)</th><th>ç”œå‘³ (1,2)</th><th>å·§å…‹åŠ› (1,2)</th><th>è‰è“ (1,2)</th><th>é»‘ç³– (1,2)</th></tr>
                </thead>
                <tbody id="matrixBody"></tbody>
            </table>
        </div>

        <div class="cal-wrapper" id="calendarGrid"></div>
        <div style="height:60px;"></div>
    </div>
</main>

<div class="fab-group" id="fabGroup" style="display:none;">
    <button class="fab-btn btn-save" onclick="saveData(false)">ğŸ’¾ å„²å­˜</button>
    <button class="fab-btn btn-save-exit" onclick="saveData(true)">ğŸ’¾ å„²å­˜ä¸¦çµæŸ</button>
</div>

<div id="importModal">
    <div class="modal-box">
        <h3>è³‡æ–™è™•ç†ä¸­...</h3>
        <p id="importStatus" style="color:#666; margin:10px 0;">è«‹ç¨å€™...</p>
        <div style="width:100%; background:#eee; height:5px; border-radius:3px; overflow:hidden;">
            <div id="progressBar" style="width:0%; background:var(--accent); height:100%; transition: width 0.3s;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyALj-w6MSC_5CgGCVUVFveoV8-ykRxcu24",
        authDomain: "crm-1225-003.firebaseapp.com",
        projectId: "crm-1225-003",
        storageBucket: "crm-1225-003.firebasestorage.app",
        messagingSenderId: "566985177794",
        appId: "1:566985177794:web:fcf21c033bd62c3bd7195b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // V15 è³‡æ–™åº«é›†åˆåç¨±
    const COL = "customers_v15_sector";

    // V15 å¸¸æ•¸å®šç¾©
    const FLAVORS = ["åŸå‘³", "ç”œå‘³", "å·§å…‹åŠ›", "è‰è“", "é»‘ç³–"];
    const DAYS = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    const PATTERNS = [{l:"å¹³æ—¥",d:[1,2,3,4,5]},{l:"æ¯å¤©",d:[0,1,2,3,4,5,6]},{l:"ä¸€ä¸‰äº”",d:[1,3,5]},{l:"äºŒå››å…­",d:[2,4,6]}];
    const HOLIDAYS = {"2025-12-25":"è–èª•","2026-1-1":"å…ƒæ—¦","2026-2-17":"é™¤å¤•","2026-2-28":"228"};
    
    // V15 è¡—å€æ¸…å–® (é †åºé‡è¦)
    const SECTORS = [
        "å¤§åŸ”", "äºŒé¬®", "æ·»ç¦", "ä¸­åœ’è¡—", "å¼˜é“", 
        "è€è¡—", "é•·æ³°è¡—", "ä»‹å£½è·¯", "æ°¸å®‰è¡—", "å…‰æ˜è·¯", 
        "å¤§åŒè·¯", "ä¸­è¯è·¯", "ä¸­æ­£è·¯", "èœå¸‚å ´", "ä¸­å±±è·¯", 
        "å¤§ä»è·¯", "å¾©èˆˆè·¯", "åŒ—å¤§", "é¶¯æ­Œ", "å…¶ä»–"
    ];

    let currentId = null;
    let currentMatrix = {};
    let manualOverrides = {}; 
    let startMonth = new Date(2025, 11, 1);
    let allCustomers = []; 

    // --- UI Init ---
    // 1. ç”Ÿæˆè¡—å€ä¸‹æ‹‰é¸å–®
    const sectorSelect = document.getElementById('inpSector');
    SECTORS.forEach(sec => {
        const opt = document.createElement('option');
        opt.value = sec;
        opt.textContent = sec;
        sectorSelect.appendChild(opt);
    });

    // 2. å¿«é€Ÿæ’ç¨‹æŒ‰éˆ•
    const ptBox = document.getElementById('patternBox');
    PATTERNS.forEach(p => {
        const btn = document.createElement('div');
        btn.className = 'pt-btn'; btn.textContent = p.l; btn.onclick=()=>applyPattern(p.d);
        ptBox.appendChild(btn);
    });

    // 3. çŸ©é™£è¡¨æ ¼
    const mxBody = document.getElementById('matrixBody');
    [1,2,3,4,5,6,0].forEach(dIdx => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="font-weight:bold; color:${dIdx===0||dIdx===6?'red':'#333'}">${DAYS[dIdx]}</td>`;
        FLAVORS.forEach(f => {
            const key = `${dIdx}_${f}`;
            const td = document.createElement('td');
            const opts = (f === "åŸå‘³") ? [1,2,4,6] : [1,2];
            let html = "";
            opts.forEach(v => html += `<span class="t-btn" data-key="${key}" data-val="${v}" onclick="toggleMatrix(this)">${v}</span>`);
            td.innerHTML = html;
            tr.appendChild(td);
        });
        mxBody.appendChild(tr);
    });

    // --- Logic ---
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('collapsed');

    window.toggleMatrix = (el) => {
        const key = el.dataset.key;
        const val = parseInt(el.dataset.val);
        const active = el.classList.contains('active');
        document.querySelectorAll(`.t-btn[data-key="${key}"]`).forEach(b => b.classList.remove('active'));
        if(active) delete currentMatrix[key];
        else { el.classList.add('active'); currentMatrix[key] = val; }
        renderCal();
    };

    function applyPattern(days) {
        document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
        currentMatrix = {};
        days.forEach(d => {
            const k = `${d}_åŸå‘³`; currentMatrix[k] = 1;
            const b = document.querySelector(`.t-btn[data-key="${k}"][data-val="1"]`);
            if(b) b.classList.add('active');
        });
        renderCal();
    }

    window.cycleState = (dateStr) => {
        let st = manualOverrides[dateStr] || 0;
        st = (st + 1) % 3;
        if(st === 0) delete manualOverrides[dateStr];
        else manualOverrides[dateStr] = st;
        renderCal();
    };

    function renderCal() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        const price = parseInt(document.getElementById('inpPrice').value) || 35;
        const doHol = document.getElementById('chkHoliday').checked;

        for(let i=0; i<6; i++) {
            const viewD = new Date(startMonth.getFullYear(), startMonth.getMonth()+i, 1);
            const y = viewD.getFullYear();
            const m = viewD.getMonth();
            const dim = new Date(y, m+1, 0).getDate();
            const fd = new Date(y, m, 1).getDay();
            let mQty = 0; let cells = "";
            for(let k=0; k<fd; k++) cells += `<div></div>`;

            for(let d=1; d<=dim; d++) {
                const dateStr = `${y}-${m+1}-${d}`;
                const dw = new Date(y,m,d).getDay();
                const isHol = HOLIDAYS[dateStr];
                
                let bQty = 0; let txt = "";
                FLAVORS.forEach(f => {
                    const q = currentMatrix[`${dw}_${f}`];
                    if(q) { bQty += q; txt += (f==="åŸå‘³"?"åŸ":f[0]) + q + " "; }
                });

                let st = "st-none"; let fQty = bQty; const ovr = manualOverrides[dateStr];
                if(isHol && !doHol) { st="st-holiday"; fQty=0; }
                else if(ovr === 1) { st="st-paused"; fQty=0; }
                else if(ovr === 2) { st="st-missed"; fQty=0; }
                else if(bQty > 0) st="st-normal";
                mQty += fQty;

                let inner = `<span class="date-num">${d}</span>`;
                if(isHol) inner += `<span style="font-size:0.6rem;color:red;position:absolute;top:2px;right:2px;">${isHol}</span>`;
                if(bQty > 0 || ovr > 0) inner += `<div class="content-badge">${txt}</div>`;
                cells += `<div class="cal-cell ${st}" onclick="cycleState('${dateStr}')">${inner}</div>`;
            }

            const card = document.createElement('div');
            card.className = "cal-card";
            card.innerHTML = `<div class="cal-header"><span>${y}/${m+1}</span><span style="color:var(--accent)">${mQty}ç“¶ | $${mQty*price}</span></div><div class="cal-grid"><div class="cal-head">æ—¥</div><div class="cal-head">ä¸€</div><div class="cal-head">äºŒ</div><div class="cal-head">ä¸‰</div><div class="cal-head">å››</div><div class="cal-head">äº”</div><div class="cal-head">å…­</div>${cells}</div>`;
            grid.appendChild(card);
        }
    }

    // --- CRUD ---
    window.resetForm = (isNew) => {
        currentId = null;
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('workspace').style.display = 'flex';
        document.getElementById('fabGroup').style.display = 'flex';
        
        // V15 é è¨­å€¼
        document.getElementById('inpSector').value = "å…¶ä»–";
        document.getElementById('inpName').value = "";
        document.getElementById('inpPhone').value = "";
        document.getElementById('inpAddr').value = "";
        document.getElementById('inpNoteA').value = ""; // V15
        document.getElementById('inpNoteB').value = ""; // V15
        document.getElementById('inpPrice').value = 35;
        document.getElementById('chkHoliday').checked = false;
        
        currentMatrix = {}; manualOverrides = {};
        document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.c-item').forEach(e => e.classList.remove('active'));
        renderCal();
        if(isNew) document.getElementById('inpName').focus();
    };

    function loadCustomer(id, data) {
        resetForm(false);
        currentId = id;
        // V15 è¼‰å…¥
        document.getElementById('inpSector').value = data.sector || "å…¶ä»–";
        document.getElementById('inpName').value = data.name;
        document.getElementById('inpPhone').value = data.phone;
        document.getElementById('inpAddr').value = data.address;
        document.getElementById('inpNoteA').value = data.noteA || "";
        document.getElementById('inpNoteB').value = data.noteB || "";
        document.getElementById('inpPrice').value = data.unitPrice;
        document.getElementById('chkHoliday').checked = data.holidayDeliver;
        
        currentMatrix = data.matrix || {};
        manualOverrides = data.manualOverrides || {};
        Object.keys(currentMatrix).forEach(k => {
            const v = currentMatrix[k];
            const btn = document.querySelector(`.t-btn[data-key="${k}"][data-val="${v}"]`);
            if(btn) btn.classList.add('active');
        });
        renderCal();
    }

    window.cloneCustomer = async () => {
        if(!currentId) return alert("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
        const newName = prompt("æ–°å®¢æˆ¶å§“å:", document.getElementById('inpName').value + "(è¤‡è£½)");
        if(!newName) return;
        const newData = {
            sector: document.getElementById('inpSector').value, // V15
            name: newName, 
            phone: "", 
            address: document.getElementById('inpAddr').value,
            noteA: document.getElementById('inpNoteA').value, // V15
            noteB: document.getElementById('inpNoteB').value, // V15
            unitPrice: parseInt(document.getElementById('inpPrice').value),
            holidayDeliver: document.getElementById('chkHoliday').checked,
            matrix: currentMatrix, manualOverrides: {}, updatedAt: serverTimestamp()
        };
        const ref = await addDoc(collection(db, COL), newData);
        loadCustomer(ref.id, newData);
        alert(`å·²è¤‡è£½ç‚º: ${newName}`);
    };

    window.saveData = async (shouldExit) => {
        const name = document.getElementById('inpName').value;
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        const payload = {
            sector: document.getElementById('inpSector').value, // V15
            name: name, 
            phone: document.getElementById('inpPhone').value,
            address: document.getElementById('inpAddr').value,
            noteA: document.getElementById('inpNoteA').value, // V15
            noteB: document.getElementById('inpNoteB').value, // V15
            unitPrice: parseInt(document.getElementById('inpPrice').value),
            holidayDeliver: document.getElementById('chkHoliday').checked,
            matrix: currentMatrix, manualOverrides: manualOverrides, updatedAt: serverTimestamp()
        };
        if(currentId) await updateDoc(doc(db, COL, currentId), payload);
        else await addDoc(collection(db, COL), payload);

        if(shouldExit) {
            document.getElementById('workspace').style.display = 'none';
            document.getElementById('fabGroup').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            currentId = null;
            alert("âœ… å„²å­˜ä¸¦æ¸…é™¤ç•«é¢");
        } else {
            alert("âœ… å„²å­˜æˆåŠŸ");
        }
    };

    // --- V15 åˆ—è¡¨é‚è¼¯ï¼šä¾è¡—å€ (SECTORS é †åº) ---
    window.filterList = () => {
        const searchVal = document.getElementById('searchInput').value.toLowerCase();
        const list = document.getElementById('customerList');
        list.innerHTML = "";

        // 1. ç¯©é¸
        const filtered = allCustomers.filter(item => {
            const c = item.data;
            const sec = c.sector || "å…¶ä»–";
            return c.name.toLowerCase().includes(searchVal) || 
                   (c.phone && c.phone.includes(searchVal)) || 
                   (c.address && c.address.includes(searchVal)) ||
                   sec.includes(searchVal);
        });

        // 2. ç¾¤çµ„åŒ– (By Sector)
        const groups = {};
        // åˆå§‹åŒ–æ‰€æœ‰è¡—å€ç¾¤çµ„ä»¥ç¢ºä¿é †åº (é¸æ“‡æ€§ï¼šå¦‚æœåªæƒ³é¡¯ç¤ºæœ‰äººçš„è¡—å€ï¼Œå°±æ‹¿æ‰é€™æ®µåˆå§‹åŒ–)
        // é€™è£¡æˆ‘å€‘åªé¡¯ç¤º"æœ‰è³‡æ–™"çš„è¡—å€ï¼Œä½†ä¾ç…§ SECTORS é †åºæ’
        
        filtered.forEach(item => {
            const sec = item.data.sector || "å…¶ä»–";
            if(!groups[sec]) groups[sec] = [];
            groups[sec].push(item);
        });

        // 3. æ’åºè¡—å€ (ä¾ SECTORS é™£åˆ—é †åº)
        const sortedKeys = Object.keys(groups).sort((a,b) => {
            let idxA = SECTORS.indexOf(a);
            let idxB = SECTORS.indexOf(b);
            if (idxA === -1) idxA = 999; // æœªçŸ¥è¡—å€æ”¾åˆ°æœ€å¾Œ
            if (idxB === -1) idxB = 999;
            return idxA - idxB;
        });

        // 4. æ¸²æŸ“
        if(sortedKeys.length === 0) {
            list.innerHTML = `<li style="padding:15px;text-align:center;color:#999;">æŸ¥ç„¡è³‡æ–™</li>`;
            return;
        }

        sortedKeys.forEach(sec => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'addr-group';
            
            // è¡—å€æ¨™é¡Œ
            const header = document.createElement('div');
            header.className = 'addr-header';
            header.textContent = `ğŸ™ï¸ ${sec} (${groups[sec].length})`;
            groupDiv.appendChild(header);

            // å®¢æˆ¶é …ç›®
            groups[sec].forEach(item => {
                const c = item.data;
                const li = document.createElement('div');
                li.className = `c-item ${item.id===currentId?'active':''}`;
                
                // ç¶­æŒ V10.4 å–®è¡Œé¡¯ç¤º (å§“å / é›»è©±)
                li.innerHTML = `
                    <div class="c-item-content">
                        <span class="c-name">${c.name}</span>
                        <span class="c-divider">/</span>
                        <span class="c-phone">${c.phone || '-'}</span>
                    </div>
                `;
                li.onclick = () => loadCustomer(item.id, c);
                groupDiv.appendChild(li);
            });

            list.appendChild(groupDiv);
        });
    };

    // Firebase ç›£è½å™¨
    onSnapshot(query(collection(db, COL), orderBy("updatedAt", "desc")), (snap) => {
        allCustomers = []; 
        snap.forEach(d => {
            allCustomers.push({ data: d.data(), id: d.id });
        });
        filterList();
    });
    
    document.getElementById('inpPrice').addEventListener('input', renderCal);
    document.getElementById('chkHoliday').addEventListener('change', renderCal);
    // è¡—å€è®Šæ›´æ™‚ä¸éœ€è¦é‡æ–° renderCalï¼Œé™¤éå½±éŸ¿é‹è²»é‚è¼¯(ç›®å‰ç„¡)

    // --- CSV Import (V15 Update) ---
    document.getElementById('csvInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (evt) => {
            const text = evt.target.result;
            const rows = text.split(/\r?\n/);
            const headers = rows[0].split(',').map(h => h.trim());
            
            // V15 æ–°å¢æ¬„ä½åµæ¸¬
            const dataIdx = {
                name: headers.indexOf("å§“å"), 
                phone: headers.indexOf("é›»è©±"), 
                addr: headers.indexOf("åœ°å€"),
                sector: headers.indexOf("è¡—å€"), // New
                noteA: headers.indexOf("å‚™è¨»A"), // New
                noteB: headers.indexOf("å‚™è¨»B"), // New
                price: headers.indexOf("å–®åƒ¹"), 
                hol: headers.indexOf("è¦‹ç´…ä¸ä¼‘"),
                days: [headers.indexOf("é€±æ—¥"), headers.indexOf("é€±ä¸€"), headers.indexOf("é€±äºŒ"), headers.indexOf("é€±ä¸‰"), headers.indexOf("é€±å››"), headers.indexOf("é€±äº”"), headers.indexOf("é€±å…­")]
            };

            if(dataIdx.name === -1) return alert("éŒ¯èª¤ï¼šCSV æ‰¾ä¸åˆ° 'å§“å' æ¬„ä½");
            
            document.getElementById('importModal').style.display = 'flex';
            let count = 0; const total = rows.length - 1;
            
            for (let i = 1; i < rows.length; i++) {
                if(!rows[i].trim()) continue;
                // è™•ç† CSV å…§çš„å¼•è™Ÿ (ç°¡æ˜“ç‰ˆ)
                const cols = rows[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                
                const matrix = {};
                dataIdx.days.forEach((colIdx, dayIdx) => { 
                    if(colIdx > -1 && cols[colIdx]) {
                        const items = cols[colIdx].split(/[,ï¼Œ]/);
                        items.forEach(item => {
                            const match = item.match(/([\u4e00-\u9fa5]+)(\d+)/); 
                            if(match) { matrix[`${dayIdx}_${match[1]}`] = parseInt(match[2]); }
                        });
                    }
                });
                
                const docData = {
                    name: cols[dataIdx.name], 
                    phone: dataIdx.phone > -1 ? cols[dataIdx.phone] : "",
                    address: dataIdx.addr > -1 ? cols[dataIdx.addr] : "",
                    // V15 é è¨­å€¼è™•ç†
                    sector: dataIdx.sector > -1 ? (cols[dataIdx.sector] || "å…¶ä»–") : "å…¶ä»–",
                    noteA: dataIdx.noteA > -1 ? cols[dataIdx.noteA] : "",
                    noteB: dataIdx.noteB > -1 ? cols[dataIdx.noteB] : "",
                    unitPrice: dataIdx.price > -1 ? (parseInt(cols[dataIdx.price]) || 35) : 35,
                    holidayDeliver: dataIdx.hol > -1 ? (cols[dataIdx.hol] === "TRUE" || cols[dataIdx.hol] === "æ˜¯") : false,
                    matrix: matrix, manualOverrides: {}, updatedAt: serverTimestamp()
                };
                await addDoc(collection(db, COL), docData);
                count++;
                document.getElementById('progressBar').style.width = Math.round((count / total) * 100) + "%";
            }
            document.getElementById('importModal').style.display = 'none';
            alert(`åŒ¯å…¥å®Œæˆï¼å…± ${count} ç­†ã€‚`);
            document.getElementById('csvInput').value = ''; 
        };
        reader.readAsText(file);
    });

    // --- CSV Export (V15 Update) ---
    window.exportCSV = () => {
        if(allCustomers.length === 0) return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");
        // V15 Header Include New Fields
        let csvContent = "\uFEFFå§“å,é›»è©±,è¡—å€,åœ°å€,å‚™è¨»A,å‚™è¨»B,å–®åƒ¹,è¦‹ç´…ä¸ä¼‘,é€±æ—¥,é€±ä¸€,é€±äºŒ,é€±ä¸‰,é€±å››,é€±äº”,é€±å…­\n";
        
        allCustomers.forEach(item => {
            const c = item.data;
            const mx = c.matrix || {};
            const daysData = [];
            for (let d = 0; d < 7; d++) {
                let dayStrParts = [];
                FLAVORS.forEach(f => {
                    const key = `${d}_${f}`;
                    if(mx[key] && mx[key] > 0) dayStrParts.push(`${f}${mx[key]}`);
                });
                daysData.push(dayStrParts.join(";")); // Use ; to separate flavors in CSV to avoid conflict
            }
            
            const row = [
                c.name, 
                c.phone || "", 
                c.sector || "å…¶ä»–", // New
                c.address || "", 
                c.noteA || "", // New
                c.noteB || "", // New
                c.unitPrice || 35, 
                c.holidayDeliver ? "TRUE" : "FALSE", 
                ...daysData
            ];
            
            const csvRow = row.map(val => {
                const str = String(val);
                return (str.includes(",") || str.includes("\"")) ? `"${str.replace(/"/g, '""')}"` : str;
            }).join(",");
            csvContent += csvRow + "\n";
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `export_v15_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

</script>
</body>
</html>