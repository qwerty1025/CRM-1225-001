<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶é…é€ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
            authDomain: "crm-ts-1225-001.firebaseapp.com",
            databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
            projectId: "crm-ts-1225-001",
            storageBucket: "crm-ts-1225-001.firebasestorage.app",
            messagingSenderId: "925760221722",
            appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // å°‡ DB åŠŸèƒ½æ›è¼‰åˆ° Window ä»¥ä¾¿ Vue ä½¿ç”¨
        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbUpdate = update;
    </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="app" class="min-h-screen flex flex-col">
        
        <nav class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
            <h1 class="text-xl font-bold flex items-center">
                <span class="mr-2">ğŸ¥›</span> é…é€ç®¡ç†
            </h1>
            <div class="space-x-2 text-sm">
                <button @click="currentView = 'manager'" :class="{'bg-blue-800': currentView==='manager'}" class="px-3 py-1 rounded transition">ç¶“ç†(é›»è…¦)</button>
                <button @click="currentView = 'delivery'" :class="{'bg-blue-800': currentView==='delivery'}" class="px-3 py-1 rounded transition">é…é€(æ‰‹æ©Ÿ)</button>
            </div>
        </nav>

        <main class="flex-grow p-4 max-w-5xl mx-auto w-full">

            <div v-if="currentView === 'manager'" class="space-y-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-bold mb-4 border-b pb-2">ğŸ“… è³‡æ–™ç”Ÿæˆ (2025/12 - 2026/01)</h2>
                    <p class="text-sm text-gray-600 mb-4">å°‡ã€Œæ¯é€±è¨­å®šã€è½‰æ›ç‚ºæœªä¾†å…©å€‹æœˆçš„æ¯æ—¥é…é€å–®ã€‚æ³¨æ„ï¼šæ­¤æ“ä½œæœƒè¦†è“‹ç¾æœ‰è³‡æ–™ã€‚</p>
                    <div class="flex gap-4">
                        <button @click="generateData" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center">
                            <span v-if="loading">è™•ç†ä¸­...</span>
                            <span v-else>ç”Ÿæˆé…é€è³‡æ–™</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">ğŸ“¦ æ¯æ—¥å‚™è²¨çµ±è¨ˆ</h2>
                        <input type="date" v-model="selectedDate" class="border p-1 rounded">
                    </div>
                    
                    <div v-if="dailyStats" class="grid grid-cols-5 gap-2 text-center">
                        <div class="bg-gray-50 p-3 rounded border">
                            <div class="text-xs text-gray-500">åŸå‘³</div>
                            <div class="text-2xl font-bold text-blue-600">{{ dailyStats.original }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded border">
                            <div class="text-xs text-gray-500">ç”œå‘³</div>
                            <div class="text-2xl font-bold text-pink-500">{{ dailyStats.sweet }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded border">
                            <div class="text-xs text-gray-500">å·§å…‹åŠ›</div>
                            <div class="text-2xl font-bold text-amber-700">{{ dailyStats.choco }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded border">
                            <div class="text-xs text-gray-500">è‰è“</div>
                            <div class="text-2xl font-bold text-red-400">{{ dailyStats.strawberry }}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded border">
                            <div class="text-xs text-gray-500">é»‘ç³–</div>
                            <div class="text-2xl font-bold text-yellow-600">{{ dailyStats.brown }}</div>
                        </div>
                    </div>
                    <div v-else class="text-center text-gray-500 py-4">ç„¡è³‡æ–™</div>
                </div>
            </div>

            <div v-if="currentView === 'delivery'" class="space-y-4">
                <div class="flex items-center justify-between bg-white p-3 rounded shadow sticky top-16 z-40">
                    <button @click="changeDate(-1)" class="p-2 bg-gray-200 rounded-full">â—€</button>
                    <div class="text-center">
                        <div class="font-bold text-lg">{{ formatDate(selectedDate) }}</div>
                        <div class="text-xs text-gray-500">{{ getWeekDay(selectedDate) }}</div>
                    </div>
                    <button @click="changeDate(1)" class="p-2 bg-gray-200 rounded-full">â–¶</button>
                </div>

                <div v-if="sortedDailyList.length > 0" class="space-y-3 pb-20">
                    <div v-for="item in sortedDailyList" :key="item.id" 
                         class="bg-white rounded-lg shadow p-4 border-l-4 transition-all"
                         :class="item.status === 'delivered' ? 'border-green-500 opacity-70' : 'border-blue-500'">
                        
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="bg-gray-200 text-xs px-1 rounded">{{ item.order }}</span>
                                    <span class="font-bold text-lg">{{ item.name }}</span>
                                </div>
                                <div class="text-xs text-gray-500">{{ item.area }}</div>
                            </div>
                            <button @click="toggleStatus(item)" 
                                    class="w-10 h-10 rounded-full flex items-center justify-center text-xl transition"
                                    :class="item.status === 'delivered' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'">
                                {{ item.status === 'delivered' ? 'âœ“' : 'â—‹' }}
                            </button>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-3 text-sm">
                            <span v-if="item.items.original" class="bg-blue-50 text-blue-700 px-2 py-1 rounded">åŸå‘³: {{item.items.original}}</span>
                            <span v-if="item.items.sweet" class="bg-pink-50 text-pink-700 px-2 py-1 rounded">ç”œå‘³: {{item.items.sweet}}</span>
                            <span v-if="item.items.choco" class="bg-amber-50 text-amber-800 px-2 py-1 rounded">å·§å…‹: {{item.items.choco}}</span>
                            <span v-if="item.items.strawberry" class="bg-red-50 text-red-700 px-2 py-1 rounded">è‰è“: {{item.items.strawberry}}</span>
                            <span v-if="item.items.brown" class="bg-yellow-50 text-yellow-700 px-2 py-1 rounded">é»‘ç³–: {{item.items.brown}}</span>
                        </div>

                        <div class="bg-gray-50 p-2 rounded">
                            <label class="text-xs text-gray-400 block mb-1">å€‹åˆ¥æ¶ˆæ¯ / å‚™è¨»</label>
                            <input type="text" v-model.lazy="item.note" @change="updateNote(item)"
                                   placeholder="ä¾‹å¦‚: é–€å£æ²’é–‹ã€æ”¹æ˜å¤©..." 
                                   class="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-sm p-1">
                        </div>
                    </div>
                </div>

                <div v-else class="text-center text-gray-500 mt-10">
                    ä»Šæ—¥ç„¡é…é€è³‡æ–™ ğŸ’¤
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const currentView = ref('delivery'); // é è¨­æ‰‹æ©Ÿç‰ˆ
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const dailyData = ref({});
                const loading = ref(false);

                // æ¨¡æ“¬è©¦ç®—è¡¨è³‡æ–™ (éƒ¨åˆ†ç¯„ä¾‹ï¼Œå¯¦ä½œæ™‚æ‡‰å®Œæ•´å¡«å…¥æˆ–åš CSV ä¸Šå‚³åŠŸèƒ½)
                // é€™è£¡å±•ç¤ºå¦‚ä½•å°‡è©¦ç®—è¡¨çµæ§‹è½‰æ›ç‚ºç¨‹å¼é‚è¼¯
                const rawSheetData = [
                    // æ ¼å¼: [é€±æœŸ, æ¬¡åº, åç¨±, è¡—å€, é€±ä¸€(5), é€±äºŒ(5)... é€±æ—¥(5)]
                    // ç‚ºç°¡åŒ–ï¼Œæ­¤è™•åƒ…æ”¾å¹¾ç­†ç¯„ä¾‹è³‡æ–™
                    { name: "å¤§åŸ”å§‘å©†", order: 1, area: "å¤§åŸ”", pattern: [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1] },
                    { name: "è©¹_è±¬è‚‰ç‡ˆ", order: 2, area: "å¤§åŸ”", pattern: [0,0,0,0,0, 2,2,2,2,2, 2,2,2,2,2, 2,2,2,2,2, 2,2,2,2,2, 2,2,2,2,2, 2,2,2,2,2] }, // (äºŒ)~(æ—¥)
                ];

                // ç›£è½æ—¥æœŸè®Šå‹•ï¼Œè®€å– Firebase
                watch(selectedDate, (newDate) => {
                    loadDateData(newDate);
                });

                function loadDateData(dateStr) {
                    if(!window.dbRef) return;
                    const dateRef = window.dbRef(window.db, `daily_operations/${dateStr}`);
                    window.dbOnValue(dateRef, (snapshot) => {
                        const data = snapshot.val();
                        dailyData.value = data || {};
                    });
                }

                // è¨ˆç®—å±¬æ€§ï¼šæ¯æ—¥çµ±è¨ˆ (ç¶“ç†ç”¨)
                const dailyStats = computed(() => {
                    const stats = { original: 0, sweet: 0, choco: 0, strawberry: 0, brown: 0 };
                    Object.values(dailyData.value).forEach(cust => {
                        if (cust.items) {
                            stats.original += parseInt(cust.items.original || 0);
                            stats.sweet += parseInt(cust.items.sweet || 0);
                            stats.choco += parseInt(cust.items.choco || 0);
                            stats.strawberry += parseInt(cust.items.strawberry || 0);
                            stats.brown += parseInt(cust.items.brown || 0);
                        }
                    });
                    return stats;
                });

                // è¨ˆç®—å±¬æ€§ï¼šæ’åºå¾Œçš„é…é€æ¸…å–® (é…é€å“¡ç”¨)
                const sortedDailyList = computed(() => {
                    const list = Object.entries(dailyData.value).map(([key, val]) => ({
                        id: key,
                        ...val
                    }));
                    // ä¾ order æ’åº
                    return list.sort((a, b) => a.order - b.order);
                });

                // åŠŸèƒ½ï¼šç”Ÿæˆ 2025/12 - 2026/01 è³‡æ–™
                async function generateData() {
                    if(!confirm("ç¢ºå®šè¦é‡æ–°ç”Ÿæˆè³‡æ–™å—ï¼Ÿé€™å°‡å¯«å…¥è³‡æ–™åº«ã€‚")) return;
                    loading.value = true;
                    
                    const updates = {};
                    const startDate = new Date("2025-12-01");
                    const endDate = new Date("2026-01-31");

                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];
                        // 0=Sun, 1=Mon... ä½† Sheet è³‡æ–™é€šå¸¸ 0=Mon or mapped accordingly.
                        // å‡è¨­ Sheet pattern æ˜¯ Mon(0-4), Tue(5-9)... Sun(30-34)
                        let jsDay = d.getDay(); // 0(Sun) - 6(Sat)
                        // è½‰æ›ç‚ºæˆ‘å€‘ pattern çš„ index: Mon=0, ..., Sun=6
                        let patternDayIndex = jsDay === 0 ? 6 : jsDay - 1; 

                        // éæ­·æ‰€æœ‰å®¢æˆ¶
                        // *è¨»ï¼šå¯¦éš›æ‡‰ç”¨æ‡‰åŒ…å«å®Œæ•´ 78 ä½å®¢æˆ¶è³‡æ–™ï¼Œæ­¤è™•ä»¥ rawSheetData ç¤ºç¯„
                        rawSheetData.forEach((cust, idx) => {
                            const startIdx = patternDayIndex * 5;
                            const items = {
                                original: cust.pattern[startIdx],
                                sweet: cust.pattern[startIdx+1],
                                choco: cust.pattern[startIdx+2],
                                strawberry: cust.pattern[startIdx+3],
                                brown: cust.pattern[startIdx+4]
                            };

                            // åªæœ‰ç•¶å¤©æœ‰æ•¸é‡æ‰å¯«å…¥
                            const total = Object.values(items).reduce((a,b)=>a+b, 0);
                            if (total > 0) {
                                updates[`daily_operations/${dateStr}/cust_${idx}`] = {
                                    name: cust.name,
                                    order: cust.order,
                                    area: cust.area,
                                    items: items,
                                    status: 'pending',
                                    note: ''
                                };
                            }
                        });
                    }

                    try {
                        await window.dbUpdate(window.dbRef(window.db), updates);
                        alert("2025/12 åŠ 2026/01 è³‡æ–™ç”Ÿæˆå®Œç•¢ï¼");
                    } catch (e) {
                        alert("éŒ¯èª¤ï¼š" + e.message);
                    }
                    loading.value = false;
                }

                // åŠŸèƒ½ï¼šæ›´æ–°ç‹€æ…‹
                function toggleStatus(item) {
                    const newStatus = item.status === 'delivered' ? 'pending' : 'delivered';
                    const updates = {};
                    updates[`daily_operations/${selectedDate.value}/${item.id}/status`] = newStatus;
                    window.dbUpdate(window.dbRef(window.db), updates);
                }

                // åŠŸèƒ½ï¼šæ›´æ–°å‚™è¨»
                function updateNote(item) {
                    const updates = {};
                    updates[`daily_operations/${selectedDate.value}/${item.id}/note`] = item.note;
                    window.dbUpdate(window.dbRef(window.db), updates);
                }

                // è¼”åŠ©åŠŸèƒ½
                function formatDate(str) {
                    return str; // å¯æ ¼å¼åŒ–ç‚º 12æœˆ25æ—¥
                }
                function getWeekDay(dateStr) {
                    const days = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'];
                    return days[new Date(dateStr).getDay()];
                }
                function changeDate(offset) {
                    const d = new Date(selectedDate.value);
                    d.setDate(d.getDate() + offset);
                    selectedDate.value = d.toISOString().split('T')[0];
                }

                onMounted(() => {
                    // åˆå§‹åŒ–è¼‰å…¥ä»Šå¤©è³‡æ–™
                    loadDateData(selectedDate.value);
                });

                return {
                    currentView,
                    selectedDate,
                    dailyData,
                    dailyStats,
                    sortedDailyList,
                    loading,
                    generateData,
                    toggleStatus,
                    updateNote,
                    formatDate,
                    getWeekDay,
                    changeDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>